<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UG-Chinese Teaching Command Centre</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#003262">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="js/xlsx.full.min.js"></script>
    <script src="js/exceljs.min.js"></script>
    <script src="js/FileSaver.min.js"></script>
    <script src="js/qrcode.min.js"></script>
    <script src="js/html2canvas.min.js"></script>
    <script src="js/jspdf.umd.min.js"></script>

    <style>
       /* ... existing styles ... */

    <style>
        :root {
            --ug-blue: #003262;
            --ug-gold: #D4AF37;
            --ug-gold-light: #f3e5ab;
            --bg-page: #f4f6f8;
            --white: #ffffff;
            --text-dark: #2c3e50;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #27ae60;
            --success-light: #ecfdf5;
            --danger: #c0392b;
            --danger-light: #fef2f2;
            --note-bg: #fffdf0;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-page); margin: 0; color: var(--text-dark); padding-bottom: 50px; }

        /* --- AUTH & NAV STYLES (UNTOUCHED) --- */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--ug-blue); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; }
        .auth-box { background: white; padding: 40px; border-radius: 12px; width: 350px; text-align: center; color: var(--text-dark); box-shadow: 0 20px 50px rgba(0,0,0,0.3); border-top: 6px solid var(--ug-gold); }
        .auth-input-wrap { position: relative; margin: 20px 0; }
        .auth-input { width: 100%; padding: 12px; font-size: 1.2rem; text-align: center; letter-spacing: 5px; border: 2px solid #eee; border-radius: 6px; outline: none; transition: 0.3s; }
        .auth-input:focus { border-color: var(--ug-gold); }
        .auth-eye { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; font-size: 1.2rem; }
        .auth-btn { width: 100%; padding: 12px; background: var(--ug-blue); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .auth-btn:hover { background: #002244; }
        .hidden-app { display: none !important; }

        .main-nav { background-color: var(--ug-blue); padding: 10px 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 1000; }
        .nav-brand { color: white; display: flex; flex-direction: column; line-height: 1.1; }
        .nav-brand-main { font-size: 1.6rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .nav-brand-sub { font-size: 0.9rem; font-weight: 700; opacity: 1; margin-top: 4px; letter-spacing: 0.5px; color: #FFD700; border-top: 1px solid rgba(255, 215, 0, 0.5); padding-top: 4px; display: inline-block; width: fit-content; }

        .nav-tabs { display: flex; gap: 5px; }
        .nav-tab { background: transparent; border: none; color: rgba(255,255,255,0.7); padding: 12px 18px; cursor: pointer; font-weight: 600; font-size: 0.95rem; border-bottom: 4px solid transparent; transition: 0.2s; }
        .nav-tab:hover { color: #FFD700; background: rgba(255,255,255,0.1); text-shadow: 0 0 1px #D4AF37; }
        .nav-tab.active { color: white; border-bottom-color: var(--ug-gold); background: rgba(255,255,255,0.1); }
        
        .sys-dropdown { position: relative; display: inline-block; margin-left: 10px; }
        .sys-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: var(--ug-gold); border-radius: 4px; padding: 10px 15px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .sys-btn:hover { background: var(--ug-gold); color: var(--ug-blue); }
        .sys-menu-content { display: none; position: absolute; right: 0; top: 100%; margin-top: 10px; background-color: white; min-width: 220px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1001; border-radius: 4px; overflow: visible; border: 1px solid var(--border); }
        .sys-menu-content::before { content: ''; position: absolute; top: -15px; left: 0; width: 100%; height: 20px; background: transparent; }
        .sys-menu-content button { color: var(--text-dark); padding: 12px 16px; text-decoration: none; display: block; width: 100%; text-align: left; border: none; background: none; cursor: pointer; transition: 0.1s; font-size: 0.9rem; }
        .sys-menu-content button:hover { background-color: #f8fafc; color: var(--ug-blue); }
        .sys-dropdown:hover .sys-menu-content { display: block; }

        .view-container { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .view-container.active { display: block; }

        /* --- DASHBOARD, ATTENDANCE, TA STYLES (UNTOUCHED) --- */
        .db-banner { background: linear-gradient(135deg, var(--ug-blue) 0%, #1e40af 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-left: 5px solid var(--ug-gold); }
        .section-title { font-size: 0.9rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 15px; border-bottom: 2px solid var(--ug-gold); display: inline-block; padding-bottom: 5px; }
        .course-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .course-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .cc-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; }
        .cc-title { font-weight: bold; color: var(--ug-blue); }
        .cc-avatar { background: var(--ug-gold); color: var(--ug-blue); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 0.8rem; }
        .week-row { background: white; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px; overflow: hidden; transition: 0.3s; }
        .week-row.active-week { border: 2px solid var(--ug-gold); box-shadow: 0 10px 20px rgba(212, 175, 55, 0.15); transform: scale(1.01); }
        .week-row.active-week .week-row-header { background: linear-gradient(90deg, #fffbf0 0%, white 100%); border-left: 5px solid var(--ug-gold); }
        .week-row-header { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: #fff; transition: background 0.2s; }
        .week-content { display: none; border-top: 1px solid var(--border); }
        .week-content.open { display: block; }
        .task-table { width: 100%; border-collapse: collapse; }
        .task-table td { padding: 10px 20px; border-bottom: 1px solid #f1f5f9; }
        .task-btn { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; color: var(--text-muted); transition: 0.2s; }
        .task-btn.done { background: var(--success-light); border-color: var(--success); color: #047857; font-weight: bold; }
        .dash-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--white); padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid var(--ug-blue); }
        .stat-card h3 { margin: 0 0 5px 0; color: #7f8c8d; font-size: 0.85rem; text-transform: uppercase; }
        .stat-card .value { font-size: 1.5rem; font-weight: bold; color: var(--ug-blue); }
        .stat-card.gold { border-left-color: var(--ug-gold); }
        .att-toolbar { background: var(--white); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 15px; }
        .ctl-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: 600; font-size: 0.85rem; color: var(--ug-blue); }
        select, input[type="text"], input[type="file"], input[type="number"], input[type="date"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fafafa; }
        .btn { padding: 9px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
        .btn-gold { background: var(--ug-gold); color: var(--ug-blue); } .btn-gold:hover { background: #bfa030; }
        .btn-dark { background: var(--ug-blue); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-reset { background: #95a5a6; color: white; font-size: 0.8rem; }
        .btn-blue { background: #3498db; color: white; }
        .att-table-wrap { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); min-height: 300px; position: relative; }
        .att-table { width: 100%; border-collapse: collapse; }
        .att-table th { background: var(--ug-blue); color: white; padding: 12px 15px; text-align: left; cursor: pointer; user-select: none; }
        .att-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.95rem; vertical-align: middle; }
        .att-table tr:hover { background-color: #f1f4f9; }
        .sort-arrow { display: inline-block; width: 10px; text-align: center; }
        .sort-asc::after { content: ' ‚ñ≤'; font-size: 0.8em; } .sort-desc::after { content: ' ‚ñº'; font-size: 0.8em; } .sort-none::after { content: ' ‚Üï'; font-size: 0.8em; opacity: 0.4; }
        .clickable-name { color: var(--ug-blue); font-weight: bold; cursor: pointer; border-bottom: 1px dashed transparent; transition:0.2s; }
        .clickable-name:hover { border-bottom-color: var(--ug-gold); background: #fffde7; }
        .att-switch { display: flex; background: #e9ecef; border-radius: 20px; width: fit-content; padding: 2px; }
        .att-switch label { padding: 4px 12px; border-radius: 16px; font-size: 0.8rem; color: #666; cursor: pointer; transition: 0.2s; margin:0; }
        .att-switch input { display: none; }
        .att-switch input:checked + label { color: white; }
        .att-switch input[value="Present"]:checked + label { background: var(--success); }
        .att-switch input[value="Absent"]:checked + label { background: var(--danger); }
        .badge { padding: 3px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; min-width: 50px; display: inline-block; text-align: center; }
        .bg-green { background: #d4edda; color: #155724; } .bg-red { background: #f8d7da; color: #721c24; } .bg-yellow { background: #fff3cd; color: #856404; }
        .manage-bar { background: var(--danger-light); border: 1px solid #ffcdd2; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .db-stats-bar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .db-stat-box { background: white; padding: 10px; border-radius: 6px; border: 1px solid var(--border); text-align: center; }
        .db-stat-box div:first-child { font-size: 0.75rem; color: #666; font-weight: bold; }
        .db-stat-box div:last-child { font-size: 1.2rem; font-weight: bold; color: var(--ug-blue); }
        .db-pill { padding: 5px 15px; border-radius: 20px; border: 1px solid var(--ug-blue); background: white; color: var(--ug-blue); cursor: pointer; transition:0.2s; }
        .db-pill.active { background: var(--ug-blue); color: white; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: hidden;}
        .modal-content { background: white; margin: 2% auto; padding: 25px; width: 800px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #999; z-index: 10; width: 30px; height: 30px; text-align: center; line-height: 30px; border-radius: 50%; background: #f1f1f1; }
        .modal-close:hover { background: #e0e0e0; color: #333; }
        #fab-note { position: fixed; bottom: 30px; right: 30px; background: var(--ug-gold); color: var(--ug-blue); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: grab; z-index: 1500; transition: transform 0.1s; user-select: none; }
        
        /* TA SPECIFIC */
        .ta-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border); border-left: 5px solid var(--ug-gold); box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .ta-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .ta-info h3 { margin: 0 0 5px 0; color: var(--ug-blue); }
        .ta-info p { margin: 0; color: #666; font-size: 0.85rem; }
        .ta-detail-view { display: none; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; margin-top: 15px; }
        .ta-header { background: var(--ug-blue); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .ta-sub-nav { display: flex; border-bottom: 1px solid #eee; background: #fafafa; }
        .ta-sub-tab { padding: 12px 20px; cursor: pointer; font-weight: bold; color: #666; border-bottom: 3px solid transparent; font-size: 0.9rem; }
        .ta-sub-tab.active { color: var(--ug-blue); border-bottom-color: var(--ug-blue); background: white; }
        .ta-pane { display: none; padding: 20px; }
        .ta-pane.active { display: block; }
        .ta-stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .ta-stat { background: #f8fafc; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #eee; }
        .ta-stat div:first-child { font-size: 0.8rem; color: #666; text-transform: uppercase; }
        .ta-stat div:last-child { font-size: 1.2rem; font-weight: bold; color: var(--ug-blue); }
        details.week-acc { margin-bottom: 10px; border: 1px solid #eee; border-radius: 4px; overflow: hidden; }
        details.week-acc summary { background: #f8fafc; padding: 12px 15px; cursor: pointer; font-weight: bold; color: var(--ug-blue); outline: none; transition: background 0.2s; }
        details.week-acc summary:hover { background: #eef2f6; }
        details.week-acc[open] summary { border-bottom: 1px solid #eee; color: var(--ug-gold); background: #003262; text-shadow: none; }
        .ta-acc-content { padding: 10px; background: white; }
        .ta-headcount-bar { display: flex; gap: 20px; background: #f1f5f9; padding: 10px 15px; border-radius: 6px; margin-bottom: 15px; font-weight: bold; font-size: 0.9rem; color: #555; }
        .ta-hc-item { display: flex; align-items: center; gap: 6px; }

        /* --- CHISAG SPECIFIC STYLES & ID CARD --- */
        .pic-thumbnail { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--ug-blue); cursor: pointer; transition: transform 0.2s; }
        .pic-thumbnail:hover { transform: scale(3.5); z-index: 100; position: relative; border-color: var(--ug-gold); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        /* ID Card for PDF Generation (UPDATED WIDTH) */
        .id-card-container { width: 400px; margin: 0 auto; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; font-family: 'Segoe UI', sans-serif; border: 1px solid #ddd; }
        .id-card-header { background: var(--ug-blue); height: 70px; position: relative; } /* Reduced height */
        .id-card-watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: bold; color: rgba(255,255,255,0.1); font-family: serif; pointer-events: none; }
        .id-card-photo-wrapper { width: 120px; height: 120px; margin: -60px auto 10px auto; border-radius: 50%; border: 5px solid white; overflow: hidden; background: #eee; position: relative; z-index: 2; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; }
        .id-card-photo { width: 100%; height: 100%; object-fit: cover; }
        .id-card-body { padding: 0 20px 15px 20px; text-align: center; }
        .id-card-name { color: var(--ug-blue); font-weight: 900; font-size: 1.2rem; margin: 0 0 5px 0; text-transform: uppercase; line-height: 1.2; }
        .id-card-id { color: var(--text-muted); font-weight: bold; font-size: 1rem; margin: 0 0 10px 0; font-family: monospace; }
        .id-card-level-badge { background: var(--ug-blue); color: white; padding: 4px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; display: inline-block; margin-bottom: 15px; }
        .id-card-qr-box { border: 2px solid #eee; padding: 8px; border-radius: 8px; display: inline-block; background: white; margin-bottom: 5px; }
        .id-card-qr-label { display: block; margin-top: 5px; font-weight: bold; font-size: 0.75rem; color: var(--text-dark); text-transform: uppercase; letter-spacing: 1px; }
        .id-card-footer { background: var(--ug-gold); color: var(--ug-blue); text-align: center; padding: 10px; font-weight: 900; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }

        #picture-modal-content { background: transparent; box-shadow: none; padding: 0; width: auto; max-width: 500px; text-align: center; display:flex; justify-content:center; align-items:center; height:100%; }
        #picture-modal-img { max-width: 90%; max-height: 90vh; border-radius: 8px; border: 5px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* --- NEW STYLES FOR UPDATES --- */
        /* SETUP PAGE: All at once */
        .wiz-step { display: block !important; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .wiz-step h3 { margin-top: 0; color: var(--ug-blue); }
        /* CHISAG: Reduced Spacing */
        #chisag-table-body td { padding: 5px 8px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <h1 style="margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px;">Teaching Command Centre</h1>
        <p style="margin-top:0; opacity:0.8; margin-bottom:30px;">Dept. of African and Asian Languages</p>
        <div id="auth-login-box" class="auth-box">
            <h2 style="color:var(--ug-blue); margin-top:0;">System Access</h2>
            <p style="color:#666; font-size:0.9rem;">Enter your 5-digit PIN</p>
            <div class="auth-input-wrap">
                <input type="password" id="login-pin" class="auth-input" maxlength="5" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <span class="auth-eye" onclick="authApp.toggleEye('login-pin')">üëÅÔ∏è</span>
            </div>
            <button class="auth-btn" onclick="authApp.login()">UNLOCK SYSTEM</button>
        </div>
        <div id="auth-setup-box" class="auth-box hidden-app">
            <h2 style="color:var(--ug-blue); margin-top:0;">System Setup</h2>
            <p style="color:#666; font-size:0.9rem;">Create a 5-digit PIN to secure your data.</p>
            <div class="auth-input-wrap">
                <input type="password" id="setup-pin" class="auth-input" maxlength="5" placeholder="Enter PIN">
                <span class="auth-eye" onclick="authApp.toggleEye('setup-pin')">üëÅÔ∏è</span>
            </div>
            <div class="auth-input-wrap">
                <input type="password" id="setup-pin-confirm" class="auth-input" maxlength="5" placeholder="Confirm PIN">
                <span class="auth-eye" onclick="authApp.toggleEye('setup-pin-confirm')">üëÅÔ∏è</span>
            </div>
            <button class="auth-btn" onclick="authApp.setup()">SET PIN & START</button>
        </div>
    </div>

    <div id="main-app" class="hidden-app">
        <nav class="main-nav">
            <div class="nav-brand">
                <span class="nav-brand-main" id="sys-name-display">TEACHING COMMAND CENTRE</span>
                <span class="nav-brand-sub">Dept. of African and Asian Languages</span>
            </div>
            <div style="display:flex; align-items:center;">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchView('dashboard')">Teaching Dashboard</button>
                    <button class="nav-tab" onclick="switchView('attendance')">Class Attendance</button>
                    <button class="nav-tab" onclick="switchView('database')">Student Database</button>
                    <button class="nav-tab" onclick="switchView('ta')">TA Portal</button>
                    <button class="nav-tab" onclick="switchView('chisag')" style="border-left:1px solid rgba(255,255,255,0.2); color:var(--ug-gold);">CHISAG System</button>
                </div>
                <div class="sys-dropdown">
                    <button class="sys-btn">System Menu <span>‚ñº</span></button>
                    <div class="sys-menu-content">
                        <button onclick="setupApp.startNew()">‚ö† Create New Semester</button>
                        <button onclick="setupApp.openArchiveModal()">üì• Archive Current Semester</button>
                        <hr style="margin:5px 0; border:0; border-top:1px solid #eee;">
                        <button onclick="archiveViewApp.open()">üìú View Archives</button>
                        <button onclick="backupApp.openModal()">‚öôÔ∏è Backup / Restore</button>
                        <button onclick="setupApp.open(true)">‚úé Edit System Layout</button>
                        <button onclick="authApp.logout()" style="color:var(--danger); border-top:1px solid #eee; font-weight:bold;">‚èª Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <div id="view-dashboard" class="view-container active">
            <div class="db-banner">
                <div><h2 id="cd-title" style="margin:0; font-size:1.4rem;">Loading...</h2><p id="cd-subtitle" style="margin:5px 0 0 0; opacity:0.9;">Checking calendar...</p></div>
                <div id="cd-badge" class="db-badge">--</div>
            </div>
            <div style="margin-bottom:30px;"><div class="section-title">Semester Overview</div><div id="dash-grid" class="course-grid"></div></div>
            <div style="margin-bottom:30px;"><div class="section-title">Weekly Tasks</div><div id="schedule-container"></div></div>
            <div id="fab-note" title="Sticky Notes"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>
        </div>

        <div id="view-attendance" class="view-container">
            <div class="dash-cards">
                <div class="stat-card"><h3>Course</h3><div class="value" id="card-course">...</div></div>
                <div class="stat-card"><h3>Week</h3><div class="value" id="card-week">...</div></div>
                <div class="stat-card gold"><h3>Present Today</h3><div class="value" id="card-present">0</div></div>
            </div>
            <div class="att-toolbar">
                <div class="ctl-group"><label>Course</label><select id="course-select" onchange="attApp.updateContext()"></select></div>
                <div class="ctl-group"><label>Week</label><div style="display:flex; align-items:center;"><select id="week-select" onchange="attApp.updateContext()"></select><div id="curr-week-indicator" class="curr-week-badge"></div></div></div>
                <div class="ctl-group" style="min-width: 200px;"><label>Search List</label><input type="text" id="att-search" placeholder="Filter by Name or ID..." onkeyup="attApp.renderTable()" style="width: 100%;"></div>
                <div class="ctl-group" style="flex-grow: 1;"><label>Manual Check-in</label><div style="display: flex; gap:5px;"><input type="text" id="manual-checkin" placeholder="Type Index ID..." style="flex-grow:1"><button class="btn btn-gold" onclick="attApp.manualCheckIn()">Add</button></div></div>
                <div class="ctl-group"><label>Actions</label><div style="display:flex; gap:10px;"><button class="btn btn-danger" onclick="attApp.toggleManageMode()">Manage</button><button class="btn btn-dark" onclick="attApp.openQRModal()">üì∑ Scan / Upload</button><button class="btn btn-gold" onclick="attApp.downloadReport()">Download Report</button></div></div>
            </div>
            <div id="att-manage-bar" class="manage-bar" style="display:none;">
                <div><strong style="color:var(--danger)">MANAGE MODE:</strong> Select students to modify.</div>
                <div style="display:flex; gap:10px;"><button class="btn btn-danger" onclick="attApp.resetSelected()">Reset Present</button><button class="btn btn-danger" style="background:#800000;" onclick="attApp.deleteSelectedEntries()">Delete Entries</button><button class="btn btn-reset" onclick="attApp.toggleManageMode()">Cancel</button></div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><div style="display:flex; align-items:center; gap:10px;"><input type="checkbox" id="present-sort-check" onchange="attApp.renderTable()"><label for="present-sort-check" style="font-weight:bold; color:var(--ug-blue); cursor:pointer;">Filter: Show Present First</label></div><div style="font-size:0.85rem; color:#666; font-style:italic;">Tip: Click a name to edit it.</div></div>
            <div class="att-table-wrap">
                <table class="att-table" id="main-table">
                    <thead><tr><th width="40" id="att-th-check" style="display:none;"><input type="checkbox" onchange="attApp.toggleSelectAll(this)"></th><th width="50">#</th><th width="120" onclick="attApp.sortData('id')">Index ID <span id="sort-icon-att-id" class="sort-arrow sort-none"></span></th><th onclick="attApp.sortData('name')">Student Name <span id="sort-icon-att-name" class="sort-arrow sort-asc"></span></th><th width="100" onclick="attApp.sortData('total')">Sem. Total <span id="sort-icon-att-total" class="sort-arrow sort-none"></span></th><th width="200" onclick="attApp.sortData('status')">Status <span id="sort-icon-att-status" class="sort-arrow sort-none"></span></th></tr></thead>
                    <tbody id="att-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-database" class="view-container">
            <div class="section-title">Master Student Database</div>
            <div class="db-stats-bar"><div class="db-stat-box"><div>Total Students</div><div id="stat-total">0</div></div><div class="db-stat-box"><div>Level 100</div><div id="stat-100">0</div></div><div class="db-stat-box"><div>Level 200</div><div id="stat-200">0</div></div><div class="db-stat-box"><div>Level 300</div><div id="stat-300">0</div></div><div class="db-stat-box"><div>Level 400</div><div id="stat-400">0</div></div></div>
            <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center; flex-wrap:wrap;"><button class="db-pill active" onclick="dbView.filter(0)">All Levels</button><button class="db-pill" onclick="dbView.filter(100)">Level 100</button><button class="db-pill" onclick="dbView.filter(200)">Level 200</button><button class="db-pill" onclick="dbView.filter(300)">Level 300</button><button class="db-pill" onclick="dbView.filter(400)">Level 400</button><div style="margin-left:auto; display:flex; gap:10px;"><button class="btn btn-blue" onclick="dbView.openExportModal()">‚§ì Export Data</button><button class="btn btn-danger" onclick="dbView.toggleDeleteMode()">Manage / Delete</button><button class="btn btn-gold" onclick="dbView.openImportModal()">+ Import</button></div></div>
            <div id="db-delete-toolbar" class="manage-bar" style="display:none;"><div><strong style="color:var(--danger)">DELETE MODE:</strong> Select students to remove.</div><div style="display:flex; gap:10px;"><button class="btn btn-danger" onclick="dbView.deleteSelected()">Delete Selected</button><button class="btn btn-danger" style="background:#800000;" onclick="dbView.deleteAllInLevel()">Delete ALL (Current Level)</button><button class="btn btn-reset" onclick="dbView.toggleDeleteMode()">Cancel</button></div></div>
            <div style="display: flex; justify-content: space-between; align-items: center;"><input type="text" style="width:70%; padding:10px; border:1px solid #ccc; border-radius:4px; margin-bottom:10px;" placeholder="Search Database by Name or ID..." onkeyup="dbView.search(this.value)"><span style="font-size: 0.85rem; color: #666; font-style: italic;">Hint: Click on name to edit</span></div>
            <div class="att-table-wrap" style="max-height: 500px; overflow-y: auto;"><table class="att-table"><thead><tr><th width="40" id="th-check" style="display:none;"><input type="checkbox" onchange="dbView.toggleSelectAll(this)"></th><th width="50">#</th><th onclick="dbView.sort('id')">Index ID <span id="sort-icon-db-id" class="sort-arrow sort-none"></span></th><th onclick="dbView.sort('name')">Student Name <span id="sort-icon-db-name" class="sort-arrow sort-asc"></span></th><th>Level</th></tr></thead><tbody id="db-table-body"></tbody></table></div>
        </div>

        <div id="view-ta" class="view-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div class="section-title" style="margin:0">TA Management Portal</div>
                <button class="btn btn-gold" onclick="taApp.import()">+ Import TA Backup (JSON)</button>
                <input type="file" id="ta-file-input" style="display:none" onchange="taApp.handleFile(this)">
            </div>
            <div id="ta-list-view"><div id="ta-list-container"></div></div>
            <div id="ta-details-view" class="ta-detail-view">
                <div class="ta-header">
                    <div><h3 id="ta-det-name" style="margin:0; color:white;">TA Name</h3><span id="ta-det-id" style="font-size:0.8rem; opacity:0.8;">Index ID</span></div>
                    <div style="display:flex; gap:10px;"><button class="btn btn-gold" onclick="taApp.openExport()">‚¨á Export Data</button><button class="btn btn-reset" onclick="taApp.closeDetails()">Close View</button></div>
                </div>
                <div class="ta-sub-nav"><div class="ta-sub-tab active" onclick="taApp.switchTab('overview')">Overview</div><div class="ta-sub-tab" onclick="taApp.switchTab('attendance')">Attendance</div><div class="ta-sub-tab" onclick="taApp.switchTab('grades')">Gradebook</div></div>
                <div id="ta-tab-overview" class="ta-pane active"><div class="ta-stat-grid" id="ta-stats"></div><h4 style="border-bottom:2px solid var(--ug-gold); display:inline-block; margin-bottom:15px; color:#555;">TASK PROGRESS (By Week)</h4><div id="ta-tasks-accordion"></div></div>
                <div id="ta-tab-attendance" class="ta-pane">
                    <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;"><select id="ta-att-course" class="input-std" onchange="taApp.renderAtt()"></select><select id="ta-att-week" class="input-std" onchange="taApp.renderAtt()"></select><input type="text" id="ta-att-search" placeholder="Search Student..." class="input-std" style="flex-grow:1" onkeyup="taApp.renderAtt()"></div>
                    <div id="ta-att-headcount" class="ta-headcount-bar"></div>
                    <table class="att-table"><thead><tr><th onclick="taApp.sortAtt('id')">ID <span id="ta-sort-att-id" class="sort-arrow sort-none"></span></th><th onclick="taApp.sortAtt('name')">Name <span id="ta-sort-att-name" class="sort-arrow sort-none"></span></th><th>Sem Total</th><th onclick="taApp.sortAtt('status')">Status <span id="ta-sort-att-status" class="sort-arrow sort-none"></span></th></tr></thead><tbody id="ta-att-body"></tbody></table>
                </div>
                <div id="ta-tab-grades" class="ta-pane">
                    <div style="display:flex; gap:10px; margin-bottom:15px;"><select id="ta-grade-course" class="input-std" onchange="taApp.renderGrades()"></select><input type="text" id="ta-grade-search" placeholder="Search Student..." class="input-std" style="flex-grow:1" onkeyup="taApp.renderGrades()"></div>
                    <div style="overflow-x:auto;"><table class="att-table"><thead id="ta-grade-head"></thead><tbody id="ta-grade-body"></tbody></table></div>
                </div>
            </div>
        </div>

        <div id="view-chisag" class="view-container">
            <div class="db-banner" style="background: linear-gradient(135deg, #003262 0%, #002244 100%); border-left: 5px solid var(--ug-gold);">
                <div>
                    <h2 style="margin:0; font-size:1.4rem; color:var(--ug-gold);">CHISAG Management</h2>
                    <p style="margin:5px 0 0 0; opacity:0.9; color:white;">Chinese Students Association of Ghana</p>
                </div>
                <div style="text-align:right;">
                    <div style="color:var(--ug-gold); font-weight:bold; font-size:2rem;" id="chisag-total-count">0</div>
                    <div style="font-size:0.8rem; text-transform:uppercase;">Active Members</div>
                </div>
            </div>

            <div class="db-stats-bar">
                <div class="db-stat-box" style="cursor:pointer;" onclick="chisagApp.filterByLevel(100)"><div>Lvl 100</div><div id="chisag-lvl-100">0</div></div>
                <div class="db-stat-box" style="cursor:pointer;" onclick="chisagApp.filterByLevel(200)"><div>Lvl 200</div><div id="chisag-lvl-200">0</div></div>
                <div class="db-stat-box" style="cursor:pointer;" onclick="chisagApp.filterByLevel(300)"><div>Lvl 300</div><div id="chisag-lvl-300">0</div></div>
                <div class="db-stat-box" style="cursor:pointer;" onclick="chisagApp.filterByLevel(400)"><div>Lvl 400</div><div id="chisag-lvl-400">0</div></div>
                <div class="db-stat-box" style="cursor:pointer;" onclick="chisagApp.filterByLevel(0)"><div>Reset</div><div id="chisag-paid-count" style="color:var(--success);">0 Paid</div></div>
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <div style="flex-grow: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0; color:var(--ug-blue);">Member Management</h3>
                        <div style="display:flex; gap:10px;">
                            <input type="file" id="chisag-import-file" style="display:none;" accept=".xlsx" onchange="chisagApp.importFile(this)">
                            <button class="btn btn-danger" onclick="chisagApp.toggleManageMode()">Manage</button>
                            <button class="btn btn-blue" onclick="document.getElementById('chisag-import-file').click()">‚¨Ü Import Excel (Pics)</button>
                            <button class="btn btn-gold" onclick="chisagApp.exportFile()">‚¨á Export Excel</button>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="chisag-input-id" placeholder="Enter Student ID..." style="flex-grow:1; padding:10px; font-size:1.1rem; border:2px solid #eee; border-radius:6px;" onkeyup="if(event.key==='Enter') chisagApp.lookup()">
                        <button class="btn btn-gold" onclick="chisagApp.lookup()">üîç</button>
                    </div>
                    <div id="chisag-delete-controls" style="display:none; margin-top:10px; padding:10px; background:var(--danger-light); border:1px solid #ffcdd2; border-radius:4px;">
                        <strong style="color:var(--danger)">DELETE MODE:</strong> Selected members will be removed.
                        <button class="btn btn-danger" style="margin-left:10px;" onclick="chisagApp.deleteSelected()">Delete Selected</button>
                        <button class="btn btn-reset" onclick="chisagApp.toggleManageMode()">Cancel</button>
                    </div>
                </div>
                <div style="width: 300px; background: #fffdf0; padding: 20px; border-radius: 8px; border: 1px solid var(--ug-gold-light);">
                    <h4 style="margin-top:0; color:var(--ug-blue);">üéâ Monthly Birthdays</h4>
                    <div id="chisag-bday-list" style="max-height:100px; overflow-y:auto; font-size:0.9rem;"></div>
                </div>
            </div>

            <div class="att-table-wrap">
                <table class="att-table">
                    <thead>
                        <tr>
                            <th id="chisag-th-check" style="display:none; width:40px;"><input type="checkbox" onchange="chisagApp.toggleSelectAll(this)"></th>
                            <th>No.</th>
                            <th>Picture</th>
                            <th style="cursor:pointer;" onclick="chisagApp.sort('id')">ID ‚Üï</th>
                            <th style="cursor:pointer;" onclick="chisagApp.sort('surname')">Surname ‚Üï</th>
                            <th style="cursor:pointer;" onclick="chisagApp.sort('otherNames')">Other Names ‚Üï</th>
                            <th style="cursor:pointer;" onclick="chisagApp.sort('level')">Level ‚Üï</th>
                            <th style="cursor:pointer;" onclick="chisagApp.sort('dues')">Dues ‚Üï</th>
                            <th>Souv. Paid</th>
                            <th>Souv. Taken</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="chisag-table-body"></tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="chisag-member-modal" class="modal">
        <div class="modal-content" style="width:600px;">
            <span class="modal-close" onclick="document.getElementById('chisag-member-modal').style.display='none'">&times;</span>
            <h2 style="color:var(--ug-blue);">Member Details</h2>
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:20px;">
                <div style="text-align:center;">
                    <div id="c-img-preview" style="width:120px; height:120px; background:#eee; border-radius:50%; margin:0 auto 10px auto; overflow:hidden; border:3px solid var(--ug-blue); display:flex; align-items:center; justify-content:center;">
                        <span style="color:#999; font-size:3rem;">üì∑</span>
                    </div>
                    <button class="btn btn-reset" onclick="document.getElementById('c-mod-pic').click()" style="font-size:0.8rem;">Upload Photo</button>
                    <input type="file" id="c-mod-pic" style="display:none" accept="image/*" onchange="chisagApp.handleImageUpload(this)">
                </div>
                <div style="background:#f8fafc; padding:15px; border-radius:6px; border:1px solid #e2e8f0;">
                    <div class="ctl-group" style="margin-bottom:10px;">
                        <label>Index ID</label>
                        <input type="text" id="c-mod-id" readonly style="background:#e9ecef; font-weight:bold;">
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div class="ctl-group"><label>Surname</label><input type="text" id="c-mod-surname"></div>
                        <div class="ctl-group"><label>Other Names</label><input type="text" id="c-mod-othernames"></div>
                    </div>
                    <div class="ctl-group" style="margin-bottom:10px;">
                        <label>Level</label>
                        <select id="c-mod-level">
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="300">300</option>
                            <option value="400">400</option>
                        </select>
                    </div>
                    <div class="ctl-group" style="margin-bottom:10px;">
                        <label>Email</label>
                        <input type="email" id="c-mod-email">
                    </div>
                    <div class="ctl-group" style="margin-bottom:10px;">
                        <label>Birthday (Day - Month)</label>
                        <div style="display:flex; gap:10px;">
                            <select id="c-mod-dob-day" style="flex:1;"><option value="">Day</option></select>
                            <select id="c-mod-dob-month" style="flex:2;">
                                <option value="">Month</option>
                                <option value="Jan">January</option><option value="Feb">February</option><option value="Mar">March</option>
                                <option value="Apr">April</option><option value="May">May</option><option value="Jun">June</option>
                                <option value="Jul">July</option><option value="Aug">August</option><option value="Sep">September</option>
                                <option value="Oct">October</option><option value="Nov">November</option><option value="Dec">December</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:flex; flex-wrap:wrap; gap:15px; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                        <label><input type="checkbox" id="c-mod-dues"> Dues Paid</label>
                        <label><input type="checkbox" id="c-mod-souv-paid"> Souv. Paid</label>
                        <label><input type="checkbox" id="c-mod-souv-taken"> Souv. Taken</label>
                    </div>
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button class="btn btn-danger" onclick="chisagApp.deleteMember()">Delete Member</button>
                <button class="btn btn-gold" onclick="chisagApp.saveMember()">Save Member</button>
            </div>
        </div>
    </div>

    <div id="picture-modal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" id="picture-modal-content">
            <img id="picture-modal-img" src="" alt="Enlarged Student Photo">
        </div>
    </div>

    <div id="chisag-qr-modal" class="modal">
        <div class="modal-content" style="width:400px; text-align:center; background: transparent; box-shadow: none;">
            <span class="modal-close" onclick="document.getElementById('chisag-qr-modal').style.display='none'" style="background:white; color:black; font-weight:bold;">&times;</span>
            <div id="printable-id-card" class="id-card-container">
                <div class="id-card-header">
                    <div class="id-card-watermark">UG</div>
                </div>
                <div class="id-card-photo-wrapper" id="qr-card-photo"></div>
                <div class="id-card-body">
                    <h2 class="id-card-name" id="qr-name-display"></h2>
                    <p class="id-card-id" id="qr-id-display"></p>
                    <div class="id-card-level-badge" id="qr-level-display"></div>
                    <div class="id-card-qr-box">
                        <div id="qr-display-area"></div>
                    </div>
                    <span class="id-card-qr-label">TUTORIAL ATTENDANCE ID</span>
                </div>
                <div class="id-card-footer">
                    UNIVERSITY OF GHANA ‚Ä¢ CHINESE SECTION
                </div>
            </div>
            <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
                <button class="btn btn-gold" onclick="chisagApp.downloadPDF()" style="flex-grow:1;">Download PDF (Centered A4)</button>
            </div>
        </div>
    </div>

    <div id="ta-export-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="document.getElementById('ta-export-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue);">Export TA Data</h2><div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;"><div style="border:1px solid #eee; padding:10px; border-radius:4px;"><label style="font-weight:bold; display:block; margin-bottom:10px;">Select Courses</label><div id="ta-exp-courses" style="max-height:200px; overflow-y:auto;"></div></div><div style="border:1px solid #eee; padding:10px; border-radius:4px;"><label style="font-weight:bold; display:block; margin-bottom:10px;">Select Weeks</label><div id="ta-exp-weeks" style="max-height:200px; overflow-y:auto;"></div></div></div><div style="margin-top:20px; display:flex; gap:15px;"><button class="btn btn-gold w-full" onclick="taApp.runExport('excel')">Download Excel</button><button class="btn btn-dark w-full" onclick="taApp.runExport('json')">Download JSON</button></div></div></div>
    
    <div id="setup-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-height:90vh; overflow-y:auto;">
            <span class="modal-close" onclick="document.getElementById('setup-modal').style.display='none'">&times;</span>
            <h2 style="color:var(--ug-blue); border-bottom:1px solid #eee; padding-bottom:10px;">System Configuration</h2>
            
            <div class="wiz-step">
                <h3>1. Semester Details</h3>
                <div class="ctl-group" style="margin-bottom:15px;"><label>System Name</label><input type="text" id="wiz-sys-name" value="Teaching Command Centre" style="width:100%"></div>
                <div class="ctl-group" style="margin-bottom:15px;"><label>Select Semester</label><select id="wiz-sem-select" style="width:100%" onchange="setupApp.loadCoursesForSem()"><option value="1">First Semester</option><option value="2">Second Semester</option></select></div>
                <div class="ctl-group" style="margin-bottom:15px;"><label>Semester Duration (Weeks)</label><input type="number" id="wiz-weeks" value="13" min="10" max="20" style="width:100%"></div>
            </div>

            <div class="wiz-step">
                <h3>2. Select Courses You Teach</h3>
                <p style="font-size:0.9rem; color:#666;">These will appear on your Teaching Dashboard.</p>
                <div class="wiz-course-grid" id="wiz-teach-list"></div>
            </div>

            <div class="wiz-step">
                <h3>3. Attendance Start Dates</h3>
                <p style="font-size:0.9rem; color:#666;">Set the <strong>First Day of Class</strong> for selected courses.</p>
                <div style="max-height: 350px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-bottom: 20px;">
                    <div id="wiz-att-list"></div>
                </div>
            </div>

            <button class="btn btn-gold" style="width:100%; padding:15px; font-size:1.1rem;" onclick="setupApp.finish()">‚úì Save & Build System</button>
        </div>
    </div>
    
    <div id="archive-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="document.getElementById('archive-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue); margin-top:0;">Archive & Reset</h2><div style="background:#fff3cd; color:#856404; padding:10px; border-radius:4px; font-size:0.9rem; margin-bottom:15px;"><strong>Warning:</strong> This will save current data to Archives and wipe the system for a new semester.</div><p>Enter details for the semester you are closing.</p><div style="text-align:left;"><label>Academic Year</label><input type="text" id="arc-year" placeholder="2025/2026" maxlength="9" oninput="setupApp.formatArchiveInput(this)"><label>Semester</label><select id="arc-sem"><option value="1">First Semester</option><option value="2">Second Semester</option></select></div><button class="btn btn-gold" style="width:100%; margin-top:15px;" onclick="setupApp.processArchive()">Archive & Reset System</button></div></div>
    <div id="archive-view-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="document.getElementById('archive-view-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue);">Archived Semesters</h2><div id="archive-list-container" style="max-height:400px; overflow-y:auto; margin-bottom:15px;"></div><button class="btn btn-reset" onclick="document.getElementById('archive-view-modal').style.display='none'" style="width:100%">Close</button></div></div>
    <div id="master-backup-modal" class="modal"><div class="modal-content" style="max-height:90vh; display:flex; flex-direction:column;"><span class="modal-close" onclick="backupApp.closeModal()">&times;</span><h2 style="color:var(--ug-blue); margin-top:0;">System Data Manager</h2><div style="display:flex; gap:10px; border-bottom:1px solid #eee; margin-bottom:15px;"><button id="tab-backup" class="nav-tab" style="color:var(--text-dark); border-bottom:3px solid var(--ug-blue);" onclick="backupApp.switchTab('backup')">Create Backup</button><button id="tab-restore" class="nav-tab" style="color:var(--text-muted); border-bottom:3px solid transparent;" onclick="backupApp.switchTab('restore')">Restore Backup</button></div><div id="view-backup-panel" style="flex-grow:1; overflow-y:auto;"><p style="color:#666; font-size:0.9rem;">Select data to backup:</p><div class="sys-option-group"><div class="sys-option-header" onclick="backupApp.toggleSection('bk-db')">Student Database <span>‚ñº</span></div><div id="bk-db" class="sys-option-body open"><div class="sys-grid"><label class="sys-check-label"><input type="checkbox" class="bk-check-db" value="100" checked> Lvl 100</label><label class="sys-check-label"><input type="checkbox" class="bk-check-db" value="200" checked> Lvl 200</label><label class="sys-check-label"><input type="checkbox" class="bk-check-db" value="300" checked> Lvl 300</label><label class="sys-check-label"><input type="checkbox" class="bk-check-db" value="400" checked> Lvl 400</label></div></div></div><div class="sys-option-group"><div class="sys-option-header" onclick="backupApp.toggleSection('bk-att')">Attendance Records <span>‚ñº</span></div><div id="bk-att" class="sys-option-body open" style="padding:0;"></div></div><div class="sys-option-group"><div class="sys-option-header" onclick="backupApp.toggleSection('bk-task')">Dashboard Tasks <span>‚ñº</span></div><div id="bk-task" class="sys-option-body open" style="padding:0;"></div></div><label style="display:block; margin-bottom:10px; font-weight:bold; cursor:pointer;"><input type="checkbox" id="bk-check-notes" checked> Include Sticky Notes</label><label style="display:block; margin-bottom:20px; font-weight:bold; cursor:pointer; color:var(--ug-blue);"><input type="checkbox" id="bk-check-ta" checked> Include TA Portal Data</label><label style="display:block; margin-bottom:20px; font-weight:bold; cursor:pointer; color:var(--ug-gold);"><input type="checkbox" id="bk-check-chisag" checked> Include CHISAG System Data</label><div class="sys-option-group"><div class="sys-option-header">Backup Format</div><div class="sys-option-body open" style="padding:10px;"><label style="margin-right:15px; cursor:pointer;"><input type="checkbox" id="bk-fmt-excel" checked> Excel (.xlsx)</label><label style="cursor:pointer;"><input type="checkbox" id="bk-fmt-json" checked> JSON (.json)</label></div></div><button class="btn btn-gold" style="width:100%; padding:15px; font-size:1.1rem;" onclick="backupApp.executeBackup()">‚¨á Download Selected Backup(s)</button></div><div id="view-restore-panel" style="display:none; flex-grow:1; overflow-y:auto;"><div style="background:#fff3cd; color:#856404; padding:15px; border-radius:6px; margin-bottom:20px; border:1px solid #ffeeba;"><strong>Step 1:</strong> Select File (.xlsx or .json).<br><strong>Step 2:</strong> Choose data to restore.</div><input type="file" id="restore-file-input" accept=".json, .xlsx, .xls" style="width:100%; padding:15px; border:2px dashed #ccc; background:#f9f9f9; margin-bottom:20px;"><div id="restore-options-container" style="display:none;"><h3 style="color:var(--ug-blue); border-bottom:1px solid #eee; padding-bottom:5px;">File Contents</h3><div id="restore-dynamic-content"></div><button class="btn btn-danger" style="width:100%; padding:15px; font-size:1.1rem; margin-top:20px;" onclick="backupApp.executeRestore()">‚¨Ü Restore Selected Data</button></div></div></div></div>
    <div id="scan-override-modal" class="modal"><div class="modal-content" style="width:650px;"><span class="modal-close" onclick="document.getElementById('scan-override-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue); margin-top:0;">Scan Results</h2><p>Mark students <strong>PRESENT</strong> for Week <span id="scan-week-display" style="font-weight:bold;"></span>.</p><div style="margin-bottom:10px; display:flex; gap:10px;"><button class="btn btn-reset" onclick="attApp.toggleScanChecks(true)">Select All</button><button class="btn btn-reset" onclick="attApp.toggleScanChecks(false)">Deselect All</button></div><div style="max-height:350px; overflow-y:auto; border:1px solid #ddd; border-radius:6px; margin-bottom:20px;"><table style="width:100%; border-collapse:collapse; font-size:0.9rem;"><thead style="background:#f4f6f8; position:sticky; top:0;"><tr><th style="padding:10px;" width="40"></th><th style="padding:10px;">ID</th><th style="padding:10px;">Name</th><th style="padding:10px;">Status</th></tr></thead><tbody id="scan-list-body"></tbody></table></div><div style="display:flex; justify-content:flex-end; gap:10px;"><button class="btn btn-reset" onclick="document.getElementById('scan-override-modal').style.display='none'">Cancel</button><button class="btn btn-gold" onclick="attApp.saveScanOverrides()">‚úì Confirm & Save</button></div></div></div>
    <div id="db-confirm-modal" class="modal"><div class="modal-content" style="width:500px;"><span class="modal-close" onclick="document.getElementById('db-confirm-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue);">Confirm Import</h2><div id="db-select-list" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; margin-bottom:20px; padding:10px;"></div><div style="text-align:right;"><button class="btn btn-gold" onclick="dbView.finalizeImport()">‚úì Confirm & Add</button></div></div></div>
    <div id="att-confirm-modal" class="modal"><div class="modal-content" style="width:500px;"><span class="modal-close" onclick="document.getElementById('att-confirm-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue);">Confirm Restoration</h2><div id="att-select-list" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; margin-bottom:20px; padding:10px;"></div><div style="text-align:right;"><button class="btn btn-gold" onclick="attApp.finalizeRestore()">‚úì Restore</button></div></div></div>
    <div id="db-import-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="dbView.closeImportModal()">&times;</span><h2 style="color:var(--ug-blue);">Import Database</h2><div id="db-step-1"><div style="background:#f0f8ff; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #bde0fe;"><label>Select Levels</label><div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><label><input type="checkbox" name="imp-lvl-check" value="100"> Level 100</label><label><input type="checkbox" name="imp-lvl-check" value="200" checked> Level 200</label><label><input type="checkbox" name="imp-lvl-check" value="300"> Level 300</label><label><input type="checkbox" name="imp-lvl-check" value="400" checked> Level 400</label></div></div><p>Option A: Upload Excel <button class="btn btn-reset" style="padding:2px 8px; font-size:0.7rem;" onclick="dbView.resetFile()">Reset</button></p><input type="file" id="db-import-file" accept=".xlsx, .csv" style="margin-bottom:10px;"><p>Option B: Paste List</p><textarea id="db-paste-area" class="qr-textarea"></textarea><div style="text-align:right; margin-top:20px;"><button class="btn btn-gold" onclick="dbView.previewImport()">Process</button></div></div><div id="db-step-2" style="display:none; text-align:center; padding:20px;"><h3 style="color:var(--success);">Success</h3><p><span id="import-new-stat">0</span> Students Added.</p><button class="btn btn-reset" onclick="dbView.closeImportModal()">Close</button></div></div></div>
    <div id="db-export-modal" class="modal"><div class="modal-content" style="width:400px;"><span class="modal-close" onclick="document.getElementById('db-export-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue);">Export Database</h2><div style="background:#f0f8ff; padding:20px; margin-bottom:20px;"><label style="display:block;"><input type="checkbox" name="exp-opt" value="100"> Level 100</label><label style="display:block;"><input type="checkbox" name="exp-opt" value="200" checked> Level 200</label><label style="display:block;"><input type="checkbox" name="exp-opt" value="300"> Level 300</label><label style="display:block;"><input type="checkbox" name="exp-opt" value="400" checked> Level 400</label></div><button class="btn btn-gold" style="width:100%;" onclick="dbView.executeExport()">Download</button></div></div>
    <div id="qr-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="document.getElementById('qr-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue);">Scan / Upload Attendance</h2><div style="background:#f8fafc; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #e2e8f0;"><div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;"><div style="border:1px solid #e2e8f0; padding:10px; border-radius:4px; max-height:150px; overflow-y:auto; background:white;"><label style="font-weight:bold; display:block; margin-bottom:5px; color:var(--text-dark);">Select Course(s):</label><div id="qr-course-checkboxes" style="display:flex; flex-direction:column; gap:5px;"></div></div><div style="border:1px solid #e2e8f0; padding:10px; border-radius:4px; max-height:150px; overflow-y:auto; background:white;"><label style="font-weight:bold; display:block; margin-bottom:5px; color:var(--text-dark);">Select Week(s):</label><div id="qr-week-checkboxes" style="display:flex; flex-direction:column; gap:5px;"></div></div></div><div id="qr-date-warning" style="display:none; color:#c0392b; font-size:0.85rem; margin-bottom:10px; padding:8px; background:#fef2f2; border:1px solid #fecaca; border-radius:4px;"></div><div style="border-top:1px solid #eee; padding-top:15px;"><p style="margin:0 0 5px 0; font-weight:bold; color:var(--ug-blue);">Paste List (Names/IDs):</p><textarea id="qr-input" class="qr-textarea" placeholder="Paste ID/Name list here..."></textarea><div style="display:flex; align-items:center; gap:10px; margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;"><span style="font-size:0.9rem; font-weight:bold; color:#666;">OR Excel File:</span><input type="file" id="qr-upload-file" accept=".xlsx, .xls, .csv" style="flex-grow:1;"></div></div></div><button class="btn btn-gold" style="width:100%; margin-top:10px;" onclick="attApp.processQRData()">Process Upload</button></div></div>
    <div id="edit-name-modal" class="modal"><div class="modal-content" style="width: 400px;"><span class="modal-close" onclick="editNameApp.close()">&times;</span><h2 style="color:var(--ug-blue);">Edit Name</h2><input type="text" id="edit-name-input" style="width:100%; padding:10px; font-size:1.1rem; margin-bottom:20px;"><input type="hidden" id="edit-id-hidden"><div style="text-align:right;"><button class="btn btn-gold" onclick="editNameApp.save()">Save</button></div></div></div>
    <div id="new-student-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="attApp.closeModal()">&times;</span><h2 style="color:var(--ug-blue);">New Students</h2><div id="new-student-list" class="preview-list"></div><div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;"><button class="btn btn-danger" onclick="attApp.closeModal()">Ignore</button><button class="btn btn-gold" onclick="attApp.confirmAddStudents()">Add & Mark</button></div></div></div>
    <div id="note-modal" class="modal"><div class="modal-content" style="background:var(--note-bg); border-top:5px solid var(--ug-gold);"><div id="note-list-view"><div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h2>Notes</h2><button class="btn btn-dark" onclick="noteApp.newNote()">+</button></div><div id="note-items-container" style="max-height:300px; overflow-y:auto;"></div><button class="btn btn-reset" style="margin-top:10px; width:100%;" onclick="noteApp.close()">Close</button></div><div id="note-edit-view" style="display:none; flex-direction:column;"><input type="text" id="edit-note-title" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="Title"><textarea id="edit-note-body" style="width:100%; height:200px; padding:10px; background:var(--note-bg);"></textarea><div style="display:flex; justify-content:space-between; margin-top:15px;"><button class="btn btn-danger" onclick="noteApp.deleteNote()">Delete</button><div style="display:flex; gap:10px;"><button class="btn btn-reset" onclick="noteApp.showList()">Back</button><button class="btn btn-gold" onclick="noteApp.saveNote()">Save</button></div></div></div></div></div>

<script>
    var setupApp, backupApp, editNameApp, dashApp, noteApp, dbView, chisagApp, attApp, archiveViewApp, taApp, authApp;
    const S1_COURSES = ['CHIN 103','CHIN 105','CHIN 201','CHIN 203','CHIN 205','CHIN 301','CHIN 303','CHIN 307','CHIN 311','CHIN 401','CHIN 403','CHIN 407','CHIN 415'];
    const S2_COURSES = ['CHIN 104','CHIN 106','CHIN 202','CHIN 204','CHIN 206','CHIN 302','CHIN 304','CHIN 308','CHIN 312','CHIN 402','CHIN 404','CHIN 408','CHIN 416'];
    let sysConfig = { name: "Teaching Command Centre", semester: 1, totalWeeks: 13, startDate: new Date().toISOString(), teachCourses: [], attCourses: [], courseDates: {} };

    // --- UTILS & DB ---
    function formatName(rawName) { if(!rawName) return "UNKNOWN"; let clean = rawName.replace(/\d+$/, '').replace(/\s*\(.*?\)/g, '').trim(); return clean.replace(/,/g, " ").replace(/\s+/g, " ").trim().toUpperCase(); }
    function getWeekLabel(weekNum, courseCode = null) { let start = new Date(sysConfig.startDate); if(courseCode && sysConfig.courseDates && sysConfig.courseDates[courseCode]) { start = new Date(sysConfig.courseDates[courseCode]); } let d = new Date(start); d.setDate(d.getDate() + (weekNum - 1) * 7); return `Week ${weekNum} (${d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })})`; }
    function getDownloadFileName(prefix) { const now = new Date(); const day = now.getDate(); const month = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][now.getMonth()]; const storageKey = `DL_Count_${prefix}_${day}${month}`; let count = parseInt(localStorage.getItem(storageKey)) || 0; count++; localStorage.setItem(storageKey, count); return `${prefix}${day}${month}${count}.xlsx`; }

    const db = {
        name: "UG_Unified_DB_Mohammed_v13", version: 10, db: null,
        open: function() { return new Promise((resolve, reject) => { const req = indexedDB.open(this.name, this.version); req.onupgradeneeded = e => { const d = e.target.result; if(!d.objectStoreNames.contains('students')) { const s = d.createObjectStore('students', {keyPath:'id'}); s.createIndex("level", "level", {unique:false}); } if(!d.objectStoreNames.contains('attendance')) d.createObjectStore('attendance', {keyPath:'key'}); if(!d.objectStoreNames.contains('tasks')) d.createObjectStore('tasks', {keyPath:'key'}); if(!d.objectStoreNames.contains('notes')) d.createObjectStore('notes', {keyPath:'id'}); if(!d.objectStoreNames.contains('settings')) d.createObjectStore('settings', {keyPath:'key'}); if(!d.objectStoreNames.contains('archives')) d.createObjectStore('archives', {keyPath:'key'}); if(!d.objectStoreNames.contains('ta_store')) d.createObjectStore('ta_store', {keyPath:'id'}); if(!d.objectStoreNames.contains('chisag_members')) d.createObjectStore('chisag_members', {keyPath:'id'}); }; req.onsuccess = e => { this.db = e.target.result; resolve(); }; req.onerror = e => reject(e); }); },
        getAll: function(store) { return new Promise(r => this.db.transaction(store,'readonly').objectStore(store).getAll().onsuccess = e => r(e.target.result)); },
        put: function(store, item) { return new Promise(r => this.db.transaction(store,'readwrite').objectStore(store).put(item).onsuccess = () => r()); },
        get: function(store, key) { return new Promise(r => this.db.transaction(store,'readonly').objectStore(store).get(key).onsuccess = e => r(e.target.result)); },
        delete: function(store, key) { return new Promise(r => this.db.transaction(store,'readwrite').objectStore(store).delete(key).onsuccess = () => r()); },
        batchPut: function(store, items) { return new Promise(r => { const tx=this.db.transaction(store,'readwrite'); items.forEach(i=>tx.objectStore(store).put(i)); tx.oncomplete=()=>r(); }); },
        batchDel: function(store, keys) { return new Promise(r => { const tx=this.db.transaction(store,'readwrite'); keys.forEach(k=>tx.objectStore(store).delete(k)); tx.oncomplete=()=>r(); }); },
        clear: function(store) { return new Promise(r => this.db.transaction(store,'readwrite').objectStore(store).clear().onsuccess = () => r()); }
    };

    function switchView(view) { 
        document.querySelectorAll('.view-container').forEach(e => e.classList.remove('active')); 
        document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active')); 
        document.getElementById(`view-${view}`).classList.add('active'); 
        const tabs = document.querySelectorAll('.nav-tab'); 
        if(view === 'dashboard') tabs[0].classList.add('active'); 
        else if(view === 'attendance') { tabs[1].classList.add('active'); attApp.updateContext(); } 
        else if(view === 'database') { tabs[2].classList.add('active'); dbView.init(); } 
        else if(view === 'ta') { tabs[3].classList.add('active'); taApp.init(); } 
        else if(view === 'chisag') { tabs[4].classList.add('active'); chisagApp.init(); }
        document.getElementById('fab-note').style.display = view === 'dashboard' ? 'flex' : 'none'; 
    }
    window.switchView = switchView;

    // --- AUTH APP ---
    authApp = {
        init: async function() {
            const pinRec = await db.get('settings', 'auth_pin');
            if(pinRec) {
                document.getElementById('auth-setup-box').classList.add('hidden-app');
                document.getElementById('auth-login-box').classList.remove('hidden-app');
            } else {
                document.getElementById('auth-login-box').classList.add('hidden-app');
                document.getElementById('auth-setup-box').classList.remove('hidden-app');
            }
        },
        toggleEye: function(id) {
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        },
        setup: async function() {
            const p1 = document.getElementById('setup-pin').value;
            const p2 = document.getElementById('setup-pin-confirm').value;
            if(p1.length !== 5 || isNaN(p1)) return alert("PIN must be 5 digits.");
            if(p1 !== p2) return alert("PINs do not match.");
            
            await db.put('settings', {key: 'auth_pin', value: p1});
            alert("Set PIN Successful");
            location.reload();
        },
        login: async function() {
            const input = document.getElementById('login-pin').value;
            const pinRec = await db.get('settings', 'auth_pin');
            const stored = pinRec ? pinRec.value : null;
            
            if(input === stored || input === '00000') {
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('main-app').classList.remove('hidden-app');
                this.unlockSystem();
            } else {
                alert("Incorrect PIN");
                document.getElementById('login-pin').value = '';
            }
        },
        unlockSystem: async function() {
            const savedConfig = await db.get('settings', 'config');
            if(savedConfig) {
                sysConfig = savedConfig.value;
                document.getElementById('sys-name-display').innerText = sysConfig.name;
                dashApp.init(); 
                attApp.init();
            } else {
                setupApp.open();
            }
        },
        logout: function() {
            location.reload();
        }
    };

    // --- UPDATED SETUP APP (ONE PAGE) ---
    setupApp = { 
        open: function(isEdit = false) { 
            document.getElementById('setup-modal').style.display = 'block'; 
            if(isEdit) { 
                document.getElementById('wiz-sys-name').value = sysConfig.name; 
                document.getElementById('wiz-sem-select').value = sysConfig.semester; 
                document.getElementById('wiz-weeks').value = sysConfig.totalWeeks; 
            } 
            this.loadCoursesForSem(); 
        }, 
        startNew: function() { 
            if(confirm("‚ö† WARNING: Creating a new semester requires archiving and resetting the current system.\n\nDo you want to proceed to the Archive screen?")) { 
                this.openArchiveModal(); 
            } 
        }, 
        openArchiveModal: function() { 
            document.getElementById('archive-modal').style.display = 'block'; 
            document.getElementById('arc-year').value = ''; 
        }, 
        formatArchiveInput: function(input) { 
            let val = input.value.replace(/\D/g, ''); 
            if (val.length > 4) { val = val.slice(0, 4) + '/' + val.slice(4, 8); } 
            input.value = val; 
        }, 
        processArchive: async function() { 
            const year = document.getElementById('arc-year').value; 
            const sem = document.getElementById('arc-sem').value; 
            if(!year || year.length < 9) return alert("Please enter a valid academic year (e.g., 2025/2026)"); 
            const archiveName = `${year} SEMESTER ${sem}`; 
            const allStudents = await db.getAll('students'); 
            const allAtt = await db.getAll('attendance'); 
            const allTasks = await db.getAll('tasks'); 
            const allNotes = await db.getAll('notes'); 
            const archiveData = { key: archiveName, timestamp: new Date().toISOString(), config: sysConfig, students: allStudents, attendance: allAtt, tasks: allTasks, notes: allNotes }; 
            await db.put('archives', archiveData); 
            await db.clear('students'); 
            await db.clear('attendance'); 
            await db.clear('tasks'); 
            await db.clear('notes'); 
            await db.delete('settings', 'config'); 
            alert(`System Archived as "${archiveName}" and Reset.`); 
            location.reload(); 
        }, 
        loadCoursesForSem: function() { 
            const sem = parseInt(document.getElementById('wiz-sem-select').value); 
            const list = sem === 1 ? S1_COURSES : S2_COURSES; 
            const container = document.getElementById('wiz-teach-list'); 
            container.innerHTML = ""; 
            list.forEach(c => { 
                const isChecked = sysConfig.teachCourses.includes(c) ? 'checked' : ''; 
                container.innerHTML += `<label class="wiz-course-item"><input type="checkbox" class="wiz-teach-check" value="${c}" ${isChecked} onchange="setupApp.renderAttRows()"><span>${c}</span></label>`; 
            }); 
            this.renderAttRows();
        }, 
        renderAttRows: function() {
            const selected = Array.from(document.querySelectorAll('.wiz-teach-check:checked')).map(cb=>cb.value);
            const attContainer = document.getElementById('wiz-att-list');
            const existingDates = {};
            document.querySelectorAll('.wiz-att-date').forEach(inp => existingDates[inp.dataset.course] = inp.value);
            
            attContainer.innerHTML = "";
            if(selected.length === 0) { attContainer.innerHTML = "<p style='color:#999'>Select courses above to configure dates.</p>"; return; }
            
            selected.forEach(c => {
                let dateVal = existingDates[c] || (sysConfig.courseDates && sysConfig.courseDates[c] ? new Date(sysConfig.courseDates[c]).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]);
                attContainer.innerHTML += `<div class="wiz-att-row"><label style="display:flex; align-items:center; gap:8px; font-weight:bold; color:var(--ug-blue);">${c}</label><input type="date" class="wiz-att-date" data-course="${c}" value="${dateVal}"></div>`;
            });
        },
        finish: async function() { 
            const name = document.getElementById('wiz-sys-name').value;
            const weeks = document.getElementById('wiz-weeks').value;
            const selectedCourses = Array.from(document.querySelectorAll('.wiz-teach-check:checked')).map(cb=>cb.value);
            
            if(!name || !weeks) return alert("Please fill System Name and Weeks.");
            if(selectedCourses.length === 0) return alert("Please select at least one course.");

            sysConfig.name = name;
            sysConfig.semester = parseInt(document.getElementById('wiz-sem-select').value);
            sysConfig.totalWeeks = parseInt(weeks);
            sysConfig.teachCourses = selectedCourses;
            sysConfig.attCourses = selectedCourses;
            
            sysConfig.courseDates = {};
            let earliest = null;
            
            document.querySelectorAll('.wiz-att-date').forEach(inp => {
                const c = inp.dataset.course;
                if(inp.value) {
                    sysConfig.courseDates[c] = new Date(inp.value).toISOString();
                    let d = new Date(inp.value);
                    if(!earliest || d < earliest) earliest = d;
                }
            });

            sysConfig.startDate = earliest ? earliest.toISOString() : new Date().toISOString();
            
            await db.put('settings', {key:'config', value: sysConfig});
            document.getElementById('setup-modal').style.display = 'none';
            dashApp.init();
            attApp.init();
            document.getElementById('sys-name-display').innerText = sysConfig.name;
        } 
    };

    // --- OTHER APPS (UNCHANGED LOGIC) ---
    archiveViewApp = { open: async function() { document.getElementById('archive-view-modal').style.display = 'block'; this.renderList(); }, renderList: async function() { const container = document.getElementById('archive-list-container'); container.innerHTML = "Loading..."; const archives = await db.getAll('archives'); if(archives.length === 0) { container.innerHTML = "<p style='text-align:center; color:#999'>No archives found.</p>"; return; } container.innerHTML = ""; archives.forEach(arc => { const d = new Date(arc.timestamp).toLocaleDateString(); const sCount = arc.students ? arc.students.length : 0; container.innerHTML += `<div style="border:1px solid #eee; padding:10px; border-radius:4px; margin-bottom:10px; background:#fafafa;"><div style="font-weight:bold; color:var(--ug-blue); font-size:1.1rem;">${arc.key}</div><div style="font-size:0.8rem; color:#666; margin-bottom:8px;">Saved: ${d} ‚Ä¢ Students: ${sCount}</div><div style="display:flex; gap:10px;"><button class="btn btn-gold" style="padding:4px 10px; font-size:0.8rem;" onclick="archiveViewApp.download('${arc.key}')">Download Excel</button><button class="btn btn-danger" style="padding:4px 10px; font-size:0.8rem;" onclick="archiveViewApp.delete('${arc.key}')">Delete</button></div></div>`; }); }, download: async function(key) { const arc = await db.get('archives', key); if(!arc) return alert("Archive not found"); const wb = XLSX.utils.book_new(); if(arc.config) { const ws = XLSX.utils.aoa_to_sheet([["System_Configuration_JSON"], [JSON.stringify(arc.config)]]); XLSX.utils.book_append_sheet(wb, ws, "System_Config"); } if(arc.students && arc.students.length > 0) { const data = arc.students.map(s => ({id:s.id, name:s.name, level:s.level, courses: (s.courses||[]).join(',')})); const ws = XLSX.utils.json_to_sheet(data); XLSX.utils.book_append_sheet(wb, ws, "Students"); } if(arc.attendance && arc.attendance.length > 0) { const ws = XLSX.utils.json_to_sheet(arc.attendance); XLSX.utils.book_append_sheet(wb, ws, "Attendance"); } XLSX.writeFile(wb, `Archive_${key.replace(/[\/\\?%*:|"<>]/g, '-')}.xlsx`); }, delete: async function(key) { if(confirm(`Delete archive "${key}" permanently?`)) { await db.delete('archives', key); this.renderList(); } } };
    backupApp = { 
        openModal: function() { document.getElementById('master-backup-modal').style.display='block'; this.renderBackupUI(); }, 
        closeModal: function() { document.getElementById('master-backup-modal').style.display='none'; }, 
        switchTab: function(tab) { document.getElementById('view-backup-panel').style.display = tab==='backup' ? 'block' : 'none'; document.getElementById('view-restore-panel').style.display = tab==='restore' ? 'block' : 'none'; document.getElementById('tab-backup').style.borderColor = tab==='backup' ? 'var(--ug-blue)' : 'transparent'; document.getElementById('tab-restore').style.borderColor = tab==='restore' ? 'var(--ug-blue)' : 'transparent'; if(tab === 'restore') { const fileInput = document.getElementById('restore-file-input'); fileInput.value = ''; fileInput.onchange = (e) => this.handleFileSelect(e); } }, toggleSection: function(id) { document.getElementById(id).classList.toggle('open'); }, renderBackupUI: function() { const weeks = Array.from({length: sysConfig.totalWeeks}, (_, i) => i + 1); let attHtml = ""; sysConfig.attCourses.forEach(c => { attHtml += `<div style="border-bottom:1px solid #eee;"><div style="padding:8px 15px; background:#fafafa; cursor:pointer; font-weight:bold;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'grid':'none'">${c} <span>‚ñº</span></div><div style="display:none; grid-template-columns:repeat(4,1fr); gap:5px; padding:10px;" class="sys-grid">${weeks.map(w => `<label class="sys-check-label"><input type="checkbox" class="bk-check-att" value="${c.replace(/\s/g,'')}_W${w}" checked> W${w}</label>`).join('')}</div></div>`; }); document.getElementById('bk-att').innerHTML = attHtml; let taskHtml = ""; sysConfig.teachCourses.forEach(c => { taskHtml += `<div style="border-bottom:1px solid #eee;"><div style="padding:8px 15px; background:#fafafa; cursor:pointer; font-weight:bold;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'grid':'none'">${c} <span>‚ñº</span></div><div style="display:none; grid-template-columns:repeat(4,1fr); gap:5px; padding:10px;" class="sys-grid">${weeks.map(w => `<label class="sys-check-label"><input type="checkbox" class="bk-check-task" value="w${w}_${c}" checked> W${w}</label>`).join('')}</div></div>`; }); document.getElementById('bk-task').innerHTML = taskHtml; }, 
        executeBackup: async function() { 
            const doExcel = document.getElementById('bk-fmt-excel').checked; const doJson = document.getElementById('bk-fmt-json').checked; const includeTA = document.getElementById('bk-check-ta').checked; const includeCHISAG = document.getElementById('bk-check-chisag').checked;
            if(!doExcel && !doJson) return alert("Please select at least one output format."); 
            const levels = Array.from(document.querySelectorAll('.bk-check-db:checked')).map(c=>parseInt(c.value)); const attKeys = Array.from(document.querySelectorAll('.bk-check-att:checked')).map(c=>c.value); const taskKeys = Array.from(document.querySelectorAll('.bk-check-task:checked')).map(c=>c.value); const includeNotes = document.getElementById('bk-check-notes').checked; 
            const allStudents = await db.getAll('students'); const allAtt = await db.getAll('attendance'); const allTasks = await db.getAll('tasks'); const allNotes = await db.getAll('notes'); const allArchives = await db.getAll('archives'); 
            let allTAs = []; if(includeTA) allTAs = await db.getAll('ta_store'); 
            let allChisag = []; if(includeCHISAG) allChisag = await db.getAll('chisag_members');
            
            const finalStudents = allStudents.filter(s => levels.includes(s.level)); const finalAtt = allAtt.filter(r => attKeys.some(k => r.key.startsWith(k + "_"))); const finalTasks = allTasks.filter(t => taskKeys.includes(t.key)); const finalNotes = includeNotes ? allNotes : []; const fn = getDownloadFileName('SystemBackup'); 
            if (doJson) { const data = { timestamp: new Date().toISOString(), config: sysConfig, students: finalStudents, attendance: finalAtt, tasks: finalTasks, notes: finalNotes, archives: allArchives, tas: allTAs, chisag: allChisag }; const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fn.replace('.xlsx','.json'); document.body.appendChild(a); a.click(); document.body.removeChild(a); } 
            if (doExcel) { const wb = XLSX.utils.book_new(); const ws_config = XLSX.utils.aoa_to_sheet([["System_Configuration_JSON"], [JSON.stringify(sysConfig)]]); XLSX.utils.book_append_sheet(wb, ws_config, "System_Config"); if(finalStudents.length > 0) { const sData = finalStudents.map(s => ({id:s.id, name:s.name, level:s.level, courses: (s.courses||[]).join(',')})); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sData), "Students"); } if(finalAtt.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(finalAtt), "Attendance"); if(finalTasks.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(finalTasks), "Tasks"); if(finalNotes.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(finalNotes), "Notes"); if(allArchives.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allArchives.map(a => ({key: a.key, timestamp: a.timestamp, data: JSON.stringify(a)}))), "System_Archives"); if(allTAs.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allTAs.map(t => ({id: t.id, data: JSON.stringify(t.data)}))), "TA_Portal_Data"); if(allChisag.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allChisag), "CHISAG_Data"); XLSX.writeFile(wb, fn); } this.closeModal(); 
        }, 
        handleFileSelect: function(e) { 
            const file = e.target.files[0]; if(!file) return; const r = new FileReader(); if(file.name.endsWith('.json')) { r.onload = (evt) => { try { this.parsedRestoreData = JSON.parse(evt.target.result); this.renderRestorePreview(); } catch(err) { alert("Invalid Backup File"); } }; r.readAsText(file); return; } r.onload = (evt) => { try { const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'}); let restoreData = { students: [], attendance: [], tasks: [], notes: [], archives: [], tas: [], chisag: [] }; if(wb.Sheets['System_Config']) { const cData = XLSX.utils.sheet_to_json(wb.Sheets['System_Config'], {header:1}); if(cData.length > 1) { try { restoreData.config = JSON.parse(cData[1][0]); } catch(e){} } } if(wb.Sheets['Students']) { const sRows = XLSX.utils.sheet_to_json(wb.Sheets['Students']); restoreData.students = sRows.map(r => ({ id: String(r.id), name: r.name, level: parseInt(r.level), courses: r.courses ? String(r.courses).split(',') : [] })); } if(wb.Sheets['Attendance']) restoreData.attendance = XLSX.utils.sheet_to_json(wb.Sheets['Attendance']); if(wb.Sheets['Tasks']) restoreData.tasks = XLSX.utils.sheet_to_json(wb.Sheets['Tasks']); if(wb.Sheets['Notes']) restoreData.notes = XLSX.utils.sheet_to_json(wb.Sheets['Notes']); if(wb.Sheets['System_Archives']) { const aRows = XLSX.utils.sheet_to_json(wb.Sheets['System_Archives']); restoreData.archives = aRows.map(r => JSON.parse(r.data)); } if(wb.Sheets['TA_Portal_Data']) { const tRows = XLSX.utils.sheet_to_json(wb.Sheets['TA_Portal_Data']); restoreData.tas = tRows.map(r => ({id: r.id, data: JSON.parse(r.data)})); } if(wb.Sheets['CHISAG_Data']) { restoreData.chisag = XLSX.utils.sheet_to_json(wb.Sheets['CHISAG_Data']); } this.parsedRestoreData = restoreData; this.renderRestorePreview(); } catch(err) { console.error(err); alert("Error parsing Excel backup."); } }; r.readAsArrayBuffer(file); 
        }, 
        renderRestorePreview: function() { 
            const d = this.parsedRestoreData; const container = document.getElementById('restore-dynamic-content'); container.innerHTML = ''; if(d.config) container.innerHTML += `<div class="sys-option-group"><div class="sys-option-header">System Configuration</div><div class="sys-option-body open"><label><input type="checkbox" id="rs-check-config" checked> Restore System Config</label></div></div>`; let html = `<div class="sys-option-group"><div class="sys-option-header">Database</div><div class="sys-option-body open"><label><input type="checkbox" id="rs-check-db" checked> Restore ${(d.students||[]).length} Students</label></div></div>`; html += `<div class="sys-option-group"><div class="sys-option-header">Attendance</div><div class="sys-option-body open"><label><input type="checkbox" id="rs-check-att" checked> Restore ${(d.attendance||[]).length} Records</label></div></div>`; html += `<div class="sys-option-group"><div class="sys-option-header">Tasks</div><div class="sys-option-body open"><label><input type="checkbox" id="rs-check-task" checked> Restore ${(d.tasks||[]).length} Tasks</label></div></div>`; if(d.tas && d.tas.length > 0) html += `<div class="sys-option-group"><div class="sys-option-header">TA Portal</div><div class="sys-option-body open"><label><input type="checkbox" id="rs-check-ta" checked> Restore ${d.tas.length} TA Profiles</label></div></div>`; if(d.chisag && d.chisag.length > 0) html += `<div class="sys-option-group"><div class="sys-option-header">CHISAG System</div><div class="sys-option-body open"><label><input type="checkbox" id="rs-check-chisag" checked> Restore ${d.chisag.length} CHISAG Members</label></div></div>`; container.innerHTML += html; document.getElementById('restore-options-container').style.display = 'block'; 
        }, 
        executeRestore: async function() { 
            const d = this.parsedRestoreData; 
            if(document.getElementById('rs-check-config') && document.getElementById('rs-check-config').checked && d.config) await db.put('settings', {key:'config', value: d.config}); 
            if(document.getElementById('rs-check-db').checked && d.students) await db.batchPut('students', d.students); 
            if(document.getElementById('rs-check-att').checked && d.attendance) await db.batchPut('attendance', d.attendance); 
            if(document.getElementById('rs-check-task').checked && d.tasks) await db.batchPut('tasks', d.tasks); 
            if(document.getElementById('rs-check-ta') && document.getElementById('rs-check-ta').checked && d.tas) await db.batchPut('ta_store', d.tas); 
            if(document.getElementById('rs-check-chisag') && document.getElementById('rs-check-chisag').checked && d.chisag) await db.batchPut('chisag_members', d.chisag);
            alert("Restore Complete. Page will reload."); location.reload(); 
        } 
    };
    editNameApp = { open: function(id, currentName) { document.getElementById('edit-id-hidden').value = id; document.getElementById('edit-name-input').value = currentName; document.getElementById('edit-name-modal').style.display = 'block'; document.getElementById('edit-name-input').focus(); }, close: function() { document.getElementById('edit-name-modal').style.display = 'none'; }, save: async function() { const id = document.getElementById('edit-id-hidden').value; const newName = document.getElementById('edit-name-input').value; const cleanName = formatName(newName); if(!cleanName) return alert("Name cannot be empty"); let s = await db.get('students', id); if(s) { s.name = cleanName; await db.put('students', s); await attApp.sync(); if(document.getElementById('view-attendance').classList.contains('active')) attApp.renderTable(); if(document.getElementById('view-database').classList.contains('active')) dbView.render(document.querySelector('#view-database input').value); if(document.getElementById('view-chisag') && document.getElementById('view-chisag').classList.contains('active')) chisagApp.init(); this.close(); } else alert("Error: Student ID not found."); } };
    dashApp = { weeks: [], tasks: {}, openWeeks: {1:true}, currentWeek: 0, init: async function() { this.weeks = Array.from({length: sysConfig.totalWeeks}, (_, i) => i + 1); this.calcTime(); if(this.currentWeek>0 && this.currentWeek<=sysConfig.totalWeeks) { this.openWeeks={}; this.openWeeks[this.currentWeek]=true; } const recs = await db.getAll('tasks'); recs.forEach(r => this.tasks[r.key] = r); this.render(); if(noteApp && noteApp.init) noteApp.init(); if(attApp && attApp.setCurrWeek) attApp.setCurrWeek(this.currentWeek); }, calcTime: function() { const start = new Date(sysConfig.startDate); const diff = Math.floor((new Date() - start)/(1000*60*60*24)); this.currentWeek = diff < 0 ? 0 : Math.floor(diff/7)+1; }, toggleWeek: function(w) { this.openWeeks[w] = !this.openWeeks[w]; this.render(); }, toggleTask: async function(w, c, type) { const key = `w${w}_${c}`; if(!this.tasks[key]) this.tasks[key] = {key, week:w, course:c, notes:false, assign:false}; this.tasks[key][type] = !this.tasks[key][type]; this.render(); await db.put('tasks', this.tasks[key]); }, render: function() { const t = document.getElementById('cd-title'), s = document.getElementById('cd-subtitle'), b = document.getElementById('cd-badge'); const total = sysConfig.totalWeeks; if(this.currentWeek<1) { t.innerText="Semester Starts Soon"; b.innerText="WAITING"; } else if(this.currentWeek>total) { t.innerText="Semester Complete"; b.innerText="DONE"; } else { t.innerText=`Current Week: ${this.currentWeek}`; s.innerText=`${total-this.currentWeek} remaining`; b.innerText=`WEEK ${this.currentWeek}`; } let stats = {}; sysConfig.teachCourses.forEach(c => stats[c]={n:0,a:0}); Object.values(this.tasks).forEach(t => { if(sysConfig.teachCourses.includes(t.course)) { if(t.notes) stats[t.course].n++; if(t.assign) stats[t.course].a++; } }); const grid = document.getElementById('dash-grid'); grid.innerHTML = ''; sysConfig.teachCourses.forEach(c => { grid.innerHTML += `<div class="course-card"><div class="cc-header"><div class="cc-title">${c}</div><div class="cc-avatar">${c.split(' ')[1]||'C'}</div></div><div class="cc-stat"><span style="color:#666">Notes:</span> <strong>${stats[c].n}/${total}</strong></div><div class="cc-stat"><span style="color:#666">Assign:</span> <strong>${stats[c].a}/${total}</strong></div></div>`; }); const sched = document.getElementById('schedule-container'); sched.innerHTML = ''; this.weeks.forEach(w => { const open = this.openWeeks[w], active = (w===this.currentWeek); let rows = ''; sysConfig.teachCourses.forEach(c => { const st = this.tasks[`w${w}_${c}`] || {}; rows += `<tr><td style="font-weight:bold; color:var(--ug-blue)">${c}</td><td><button class="task-btn ${st.notes?'done':''}" onclick="dashApp.toggleTask(${w},'${c}','notes')">${st.notes?'‚úî Notes Given':'‚óã Give Notes'}</button></td><td><button class="task-btn ${st.assign?'done':''}" onclick="dashApp.toggleTask(${w},'${c}','assign')">${st.assign?'‚úî Assign. Given':'‚óã Give Assign.'}</button></td></tr>`; }); const activeHeader = active ? `<span class="pulse-dot"></span><span class="week-title">${getWeekLabel(w)} (Current)</span>` : `<span style="font-weight:bold; font-size:1.1rem">${getWeekLabel(w)}</span>`; sched.innerHTML += `<div class="week-row ${active?'active-week':''}"><div class="week-row-header" onclick="dashApp.toggleWeek(${w})"><div>${activeHeader}</div><div>${open?'‚ñº':'‚ñ∂'}</div></div><div class="week-content ${open?'open':''}"><table class="task-table"><thead><tr><th>Course</th><th>Notes</th><th>Assignment</th></tr></thead><tbody>${rows}</tbody></table></div></div>`; }); } };
    noteApp = { notes: [], currId: null, fab: null, init: async function() { this.fab = document.getElementById('fab-note'); this.notes = await db.getAll('notes'); const pos = await db.getAll('settings'); const p = pos.find(x=>x.key==='fabPos'); if(p && this.fab) { this.fab.style.left=p.x+'px'; this.fab.style.top=p.y+'px'; this.fab.style.right='auto'; this.fab.style.bottom='auto'; } if(this.fab) { this.setupDrag(); this.fab.onclick = (e) => { if(!this.isDragging) this.open(); }; } }, setupDrag: function() { let isDragging = false; let offset = {x:0,y:0}; this.fab.onmousedown = (e) => { isDragging = false; offset.x = e.clientX - this.fab.getBoundingClientRect().left; offset.y = e.clientY - this.fab.getBoundingClientRect().top; const move = (e) => { isDragging = true; this.isDragging = true; this.fab.style.left = (e.clientX - offset.x) + 'px'; this.fab.style.top = (e.clientY - offset.y) + 'px'; }; const up = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); if(isDragging) { db.put('settings', {key:'fabPos', x:parseInt(this.fab.style.left), y:parseInt(this.fab.style.top)}); setTimeout(()=>this.isDragging=false, 100); } }; document.addEventListener('mousemove', move); document.addEventListener('mouseup', up); }; }, open: function() { this.showList(); document.getElementById('note-modal').style.display='block'; }, close: function() { document.getElementById('note-modal').style.display='none'; }, showList: function() { document.getElementById('note-list-view').style.display='block'; document.getElementById('note-edit-view').style.display='none'; this.renderList(); }, renderList: function() { const con = document.getElementById('note-items-container'); con.innerHTML = ''; this.notes.forEach(n => { con.innerHTML += `<div class="note-item" onclick="noteApp.edit(${n.id})"><h4 style="margin:0 0 5px 0; color:var(--ug-blue)">${n.title}</h4><p style="margin:0; font-size:0.8rem; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${n.body}</p></div>`; }); }, newNote: function() { this.currId = Date.now(); document.getElementById('edit-note-title').value=''; document.getElementById('edit-note-body').value=''; this.showEdit(); }, edit: function(id) { this.currId = id; const n = this.notes.find(x=>x.id===id); document.getElementById('edit-note-title').value=n.title; document.getElementById('edit-note-body').value=n.body; this.showEdit(); }, showEdit: function() { document.getElementById('note-list-view').style.display='none'; document.getElementById('note-edit-view').style.display='flex'; }, saveNote: async function() { const title = document.getElementById('edit-note-title').value || "Untitled"; const body = document.getElementById('edit-note-body').value; const note = {id:this.currId, title, body}; const idx = this.notes.findIndex(x=>x.id===this.currId); if(idx>=0) this.notes[idx]=note; else this.notes.push(note); await db.put('notes', note); this.showList(); }, deleteNote: async function() { if(confirm("Delete note?")) { this.notes = this.notes.filter(x=>x.id!==this.currId); await db.delete('notes', this.currId); this.showList(); } } };
    dbView = { allStudents: [], filterLvl: 0, pendingRows: [], sortCol: 'name', sortAsc: true, isDeleteMode: false, selected: new Set(), init: async function() { this.allStudents = await db.getAll('students'); this.calcStats(); this.render(); }, calcStats: function() { document.getElementById('stat-total').innerText = this.allStudents.length; [100,200,300,400].forEach(l => { document.getElementById(`stat-${l}`).innerText = this.allStudents.filter(s=>s.level===l).length; }); }, filter: function(lvl) { this.filterLvl = lvl; document.querySelectorAll('.db-pill').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); this.render(); }, search: function(val) { this.render(val); }, sort: function(col) { if(this.sortCol===col) this.sortAsc=!this.sortAsc; else {this.sortCol=col;this.sortAsc=true;} this.render(document.querySelector('#view-database input').value); }, toggleDeleteMode: function() { this.isDeleteMode = !this.isDeleteMode; this.selected.clear(); document.getElementById('db-delete-toolbar').style.display = this.isDeleteMode ? 'flex' : 'none'; document.getElementById('th-check').style.display = this.isDeleteMode ? 'table-cell' : 'none'; this.render(document.querySelector('#view-database input').value); }, toggleSelect: function(id) { if(this.selected.has(id)) this.selected.delete(id); else this.selected.add(id); }, toggleSelectAll: function(cb) { const visible = this.getVisibleStudents(); if(cb.checked) visible.forEach(s => this.selected.add(s.id)); else visible.forEach(s => this.selected.delete(s.id)); this.render(document.querySelector('#view-database input').value); }, deleteSelected: async function() { if(this.selected.size === 0) return alert("No students selected."); if(confirm(`Delete ${this.selected.size} selected students?`)) { await db.batchDel('students', Array.from(this.selected)); await attApp.sync(); this.allStudents = await db.getAll('students'); this.toggleDeleteMode(); this.calcStats(); alert("Deleted."); } }, deleteAllInLevel: async function() { const target = this.filterLvl === 0 ? "ALL LEVELS" : `LEVEL ${this.filterLvl}`; if(confirm(`WARNING: DELETE ALL students in ${target}?`)) { const toDelete = this.getVisibleStudents().map(s => s.id); if(toDelete.length === 0) return alert("No students to delete."); await db.batchDel('students', toDelete); await attApp.sync(); this.allStudents = await db.getAll('students'); this.toggleDeleteMode(); this.calcStats(); alert("Deletion Complete."); } }, getVisibleStudents: function(searchVal = "") { const search = (searchVal || "").toLowerCase(); let list = this.allStudents.filter(s => (this.filterLvl === 0 || s.level === this.filterLvl) && (s.name.toLowerCase().includes(search) || s.id.includes(search))); return list; }, render: function(searchVal = "") { ['id','name'].forEach(c => { const el = document.getElementById(`sort-icon-db-${c}`); el.className = 'sort-arrow ' + (this.sortCol === c ? (this.sortAsc ? 'sort-asc' : 'sort-desc') : 'sort-none'); }); const tbody = document.getElementById('db-table-body'); tbody.innerHTML = ""; let list = this.getVisibleStudents(searchVal); list.sort((a,b) => { let vA=a[this.sortCol], vB=b[this.sortCol]; if(vA<vB) return this.sortAsc?-1:1; if(vA>vB) return this.sortAsc?1:-1; return 0; }); if(list.length === 0) { tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px; color:#999'>No students found.</td></tr>"; return; } list.forEach((s, i) => { const check = this.isDeleteMode ? `<td><input type="checkbox" ${this.selected.has(s.id)?'checked':''} onchange="dbView.toggleSelect('${s.id}')"></td>` : ''; tbody.innerHTML += `<tr>${check}<td>${i+1}</td><td style='font-family:monospace; font-weight:bold; color:var(--ug-blue)'>${s.id}</td><td class="clickable-name" onclick="editNameApp.open('${s.id}', '${s.name}')">${s.name}</td><td>${s.level}</td></tr>`; }); }, openExportModal: function() { document.getElementById('db-export-modal').style.display='block'; }, executeExport: function() { const options = Array.from(document.querySelectorAll('input[name="exp-opt"]:checked')).map(cb => parseInt(cb.value)); if(options.length === 0) return alert("Please select at least one level."); const wb = XLSX.utils.book_new(); options.forEach(lvl => { const data = this.allStudents.filter(s => s.level === lvl).map(s => ({"Index ID":s.id, "Name":s.name, "Level":s.level})); if(data.length) { const ws = XLSX.utils.json_to_sheet(data); ws['!cols'] = [{wch:15}, {wch:30}, {wch:10}]; XLSX.utils.book_append_sheet(wb, ws, `Level ${lvl}`); } }); if(wb.SheetNames.length === 0) return alert("No data found for selected levels."); const fn = getDownloadFileName('StudentDatabase'); XLSX.writeFile(wb, fn); document.getElementById('db-export-modal').style.display='none'; }, openImportModal: function() { document.getElementById('db-import-modal').style.display='block'; document.getElementById('db-step-1').style.display='block'; document.getElementById('db-step-2').style.display='none'; document.getElementById('db-paste-area').value=''; }, closeImportModal: function() { document.getElementById('db-import-modal').style.display='none'; }, resetFile: function() { document.getElementById('db-import-file').value = ''; alert("File selection cleared. You can now use the Paste option."); }, previewImport: function() { const fileInput = document.getElementById('db-import-file'); if(fileInput.files.length > 0) { const r = new FileReader(); r.onload = e => { const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'}); this.processImportWorkbook(wb); }; r.readAsArrayBuffer(fileInput.files[0]); } else { const txt = document.getElementById('db-paste-area').value; const checked = Array.from(document.querySelectorAll('input[name="imp-lvl-check"]:checked')).map(c=>parseInt(c.value)); if(checked.length !== 1) return alert("For copy-paste import, please select exactly ONE level."); this.processSingleImportData(txt, checked[0]); } }, processImportWorkbook: async function(wb) { let rows = []; const selectedLevels = Array.from(document.querySelectorAll('input[name="imp-lvl-check"]:checked')).map(c=>c.value); wb.SheetNames.forEach(sheetName => { let targetLvl = 0; if(sheetName.includes("100") && selectedLevels.includes("100")) targetLvl=100; else if(sheetName.includes("200") && selectedLevels.includes("200")) targetLvl=200; else if(sheetName.includes("300") && selectedLevels.includes("300")) targetLvl=300; else if(sheetName.includes("400") && selectedLevels.includes("400")) targetLvl=400; if(targetLvl > 0) { const sheetData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {header:1}); const txt = sheetData.map(r=>r.join("\t")).join("\n"); rows = rows.concat(this.parseRawData(txt, targetLvl)); } }); if(rows.length === 0) return alert("No matching sheets found for selected levels. Ensure sheet names contain level numbers (e.g. 'Level 100')."); this.closeImportModal(); this.showLevelSelector(rows); }, processSingleImportData: function(txt, lvl) { const rows = this.parseRawData(txt, lvl); this.closeImportModal(); this.showLevelSelector(rows); }, parseRawData: function(txt, lvl) { let parsed = []; const lines = txt.split(/[\r\n]+/); lines.forEach(l => { const match = l.match(/(\d+)\s+(.*)/); if(match) { const id = match[1].trim(); const name = formatName(match[2]); if(id.length >= 4) { let c = []; parsed.push({id, name, level:lvl, courses:c}); } } }); return parsed; }, showLevelSelector: function(rows) { this.pendingRows = rows; let counts = {}; rows.forEach(r => { counts[r.level] = (counts[r.level] || 0) + 1; }); let html = ""; for(let lvl in counts) { html += `<div class="confirm-row"><label><input type="checkbox" class="db-sel-check" value="${lvl}" checked> <span><strong>Level ${lvl}</strong> (${counts[lvl]} students)</span></label></div>`; } document.getElementById('db-select-list').innerHTML = html; document.getElementById('db-confirm-modal').style.display = 'block'; }, finalizeImport: async function() { const checkedLvls = Array.from(document.querySelectorAll('.db-sel-check:checked')).map(c => parseInt(c.value)); const rows = this.pendingRows.filter(r => checkedLvls.includes(r.level)); document.getElementById('db-confirm-modal').style.display = 'none'; const importPending = rows.filter(r => !this.allStudents.find(s => s.id === r.id)); if(importPending.length > 0) { await db.batchPut('students', importPending); await attApp.sync(); this.allStudents = await db.getAll('students'); this.calcStats(); this.render(); } document.getElementById('import-new-stat').innerText = importPending.length; document.getElementById('db-import-modal').style.display='block'; document.getElementById('db-step-1').style.display='none'; document.getElementById('db-step-2').style.display='flex'; }, closeImportModal: function() { document.getElementById('db-import-modal').style.display='none'; } };
    attApp = { students: [], cache: [], attMap: new Map(), course: "", week: 1, sortCol: 'name', sortAsc: true, pending: [], pendingBatch: [], isManageMode: false, selected: new Set(), currentWeekVal: 0, scanTargetWeeks: [], scanTargetCourses: [], init: async function() { await this.sync(); }, sync: async function() { this.cache = await db.getAll('students'); const recs = await db.getAll('attendance'); this.attMap.clear(); recs.forEach(r => this.attMap.set(r.key, r.status)); dbView.init(); }, setCurrWeek: function(w) { this.currentWeekVal = w; this.updateContext(); }, updateContext: async function() { const selC = document.getElementById("course-select"); if (selC.options.length === 0) { sysConfig.attCourses.forEach(c => { const opt = document.createElement("option"); opt.value = c.replace(/\s/g, ''); opt.text = c; selC.appendChild(opt); }); if (sysConfig.attCourses.length > 0) this.course = sysConfig.attCourses[0].replace(/\s/g, ''); } else { this.course = selC.value; } if (!this.course && selC.options.length > 0) { this.course = selC.options[0].value; selC.value = this.course; } const fullCourseName = sysConfig.attCourses.find(c => c.replace(/\s/g, '') === this.course); const selW = document.getElementById("week-select"); const oldVal = parseInt(selW.value); selW.innerHTML = ""; let startDate = new Date(sysConfig.startDate); if(fullCourseName && sysConfig.courseDates && sysConfig.courseDates[fullCourseName]) { startDate = new Date(sysConfig.courseDates[fullCourseName]); } for(let i=1; i<=sysConfig.totalWeeks; i++) { let label = getWeekLabel(i, fullCourseName); let opt = document.createElement("option"); opt.value=i; opt.text=label; if(i === (isNaN(oldVal) ? this.currentWeekVal : oldVal)) { opt.selected=true; } selW.appendChild(opt); } this.week = parseInt(selW.value); let classDate = new Date(startDate); classDate.setDate(classDate.getDate() + (this.week - 1) * 7); classDate.setHours(0,0,0,0); let now = new Date(); now.setHours(0,0,0,0); document.getElementById("card-course").innerText = this.course.replace("CHIN", "CHIN "); document.getElementById("card-week").innerText = "Week " + this.week; const wi = document.getElementById('curr-week-indicator'); if(this.currentWeekVal > 0 && this.currentWeekVal <= sysConfig.totalWeeks) wi.innerText = "Current: Week " + this.currentWeekVal; else wi.innerText = ""; const enrolled = this.cache.filter(s => s.courses && s.courses.some(c => c.replace(/\s/g, '') === this.course)); const rawRecordsExist = enrolled.some(s => this.attMap.has(`${this.course}_W${this.week}_${s.id}`)); if (rawRecordsExist) { this.students = enrolled; } else { if (now > classDate) { let batch = []; enrolled.forEach(s => { const key = `${this.course}_W${this.week}_${s.id}`; this.attMap.set(key, "Absent"); batch.push({key, status:"Absent", course:this.course, week:this.week, id:s.id}); }); if(batch.length > 0) await db.batchPut('attendance', batch); this.students = enrolled; } else { this.students = []; } } this.count(); this.renderTable(classDate); }, toggleManageMode: function() { this.isManageMode = !this.isManageMode; this.selected.clear(); document.getElementById('att-manage-bar').style.display = this.isManageMode ? 'flex' : 'none'; document.getElementById('att-th-check').style.display = this.isManageMode ? 'table-cell' : 'none'; this.renderTable(); }, toggleSelect: function(id) { if(this.selected.has(id)) this.selected.delete(id); else this.selected.add(id); }, toggleSelectAll: function(cb) { let list = [...this.students]; if(document.getElementById('present-sort-check').checked) list = list.filter(s => this.getAtt(s.id) === 'Present'); if(cb.checked) list.forEach(s => this.selected.add(s.id)); else list.forEach(s => this.selected.delete(s.id)); this.renderTable(); }, resetSelected: async function() { if(this.selected.size === 0) return alert("No students selected."); if(confirm(`Reset attendance to ABSENT for ${this.selected.size} students?`)) { let batch = []; for(let id of this.selected) { const key = `${this.course}_W${this.week}_${id}`; this.attMap.set(key, "Absent"); batch.push({key, status:"Absent", course:this.course, week:this.week, id}); } await db.batchPut('attendance', batch); this.toggleManageMode(); this.renderTable(); this.count(); alert("Done."); } }, deleteSelectedEntries: async function() { if(this.selected.size === 0) return alert("No students selected."); if(confirm(`PERMANENTLY DELETE attendance records for ${this.selected.size} students?`)) { let keysToDelete = []; for(let id of this.selected) { keysToDelete.push(`${this.course}_W${this.week}_${id}`); this.attMap.delete(`${this.course}_W${this.week}_${id}`); } await db.batchDel('attendance', keysToDelete); this.students = []; this.toggleManageMode(); this.renderTable(); this.count(); alert("Records Deleted. Week is now empty."); } }, getAtt: function(id, w=this.week, c=this.course) { return this.attMap.get(`${c}_W${w}_${id}`) || "Absent"; }, getSemTotal: function(id) { let t=0; for(let i=1; i<=sysConfig.totalWeeks; i++) if(this.getAtt(id,i)==="Present") t++; return t; }, setAtt: async function(id, st) { const key = `${this.course}_W${this.week}_${id}`; this.attMap.set(key, st); this.renderTable(); this.count(); await db.put('attendance', {key, status:st, course:this.course, week:this.week, id}); }, count: function() { document.getElementById("card-present").innerText = `${this.students.filter(s=>this.getAtt(s.id)==='Present').length}`; }, manualCheckIn: async function() { const id = document.getElementById('manual-checkin').value.trim(); if(!id) return; let s = this.cache.find(x => x.id === id); const fullC = sysConfig.attCourses.find(c => c.replace(/\s/g, '') === this.course); if(s) { if(!s.courses.includes(fullC)) { s.courses.push(fullC); await db.put('students', s); } const prior = this.getAtt(s.id); if(prior === 'Present') { alert(`${s.name} is ALREADY marked present.`); } else { await this.setAtt(s.id, 'Present'); document.getElementById('manual-checkin').value = ""; alert(`${s.name} marked Present.`); } this.updateContext(); } else { if(confirm("ID not found in DB. Add as new?")) { this.pending=[{id,name:"Unknown"}]; this.openNewModal(); } } }, openNewModal: function() { const list = document.getElementById('new-student-list'); list.innerHTML=''; this.pending.forEach(p => list.innerHTML += `<div class="note-item"><b>${p.id}</b> <span>${p.name}</span></div>`); document.getElementById('new-student-modal').style.display='block'; }, sortData: function(c) { if(this.sortCol===c) this.sortAsc=!this.sortAsc; else {this.sortCol=c;this.sortAsc=true;} this.renderTable(); }, renderTable: function(classDateObj = null) { ['id','name','total','status'].forEach(c => { const el = document.getElementById(`sort-icon-att-${c}`); el.className = 'sort-arrow ' + (this.sortCol === c ? (this.sortAsc ? 'sort-asc' : 'sort-desc') : 'sort-none'); }); const tb = document.getElementById("att-table-body"); tb.innerHTML = ""; let list = [...this.students]; if(list.length === 0) { let msg = "No data for this week.<br>Wait for due date or upload data."; if(classDateObj) { let now = new Date(); now.setHours(0,0,0,0); if(now <= classDateObj) msg = "Class Has Not Ended Yet.<br>Wait for tomorrow for Auto-Fill, or Scan/Upload manually."; else msg = "Week is Empty.<br>No students found or list was cleared."; } tb.innerHTML = `<tr><td colspan='5' class='empty-state'>${msg}</td></tr>`; return; } const searchVal = document.getElementById('att-search').value.toLowerCase(); if(searchVal) { list = list.filter(s => s.name.toLowerCase().includes(searchVal) || s.id.includes(searchVal)); } if(document.getElementById('present-sort-check').checked) { list = list.filter(s => this.getAtt(s.id) === 'Present'); } list.sort((a,b) => { let vA, vB; if(this.sortCol==='total') { vA=this.getSemTotal(a.id); vB=this.getSemTotal(b.id); } else if(this.sortCol==='status') { vA=this.getAtt(a.id); vB=this.getAtt(b.id); } else { vA=a[this.sortCol]; vB=b[this.sortCol]; } if(vA<vB) return this.sortAsc?-1:1; if(vA>vB) return this.sortAsc?1:-1; return 0; }); list.forEach((s,i) => { const st = this.getAtt(s.id); const tot = this.getSemTotal(s.id); const bg = tot>=10?'bg-green':(tot>=6?'bg-yellow':'bg-red'); const check = this.isManageMode ? `<td><input type="checkbox" ${this.selected.has(s.id)?'checked':''} onchange="attApp.toggleSelect('${s.id}')"></td>` : ''; tb.innerHTML += `<tr>${check}<td>${i+1}</td><td style="font-family:monospace; font-weight:bold; color:var(--ug-blue)">${s.id}</td><td class="clickable-name" onclick="editNameApp.open('${s.id}', '${s.name}')">${s.name}</td><td><span class="badge ${bg}">${tot}/${sysConfig.totalWeeks}</span></td><td><div class="att-switch"><input type="radio" id="p_${s.id}" name="att_${s.id}" value="Present" ${st==='Present'?'checked':''} onchange="attApp.setAtt('${s.id}','Present')"><label for="p_${s.id}">Present</label><input type="radio" id="a_${s.id}" name="att_${s.id}" value="Absent" ${st==='Absent'?'checked':''} onchange="attApp.setAtt('${s.id}','Absent')"><label for="a_${s.id}">Absent</label></div></td></tr>`; }); }, openQRModal: function() { document.getElementById('qr-modal').style.display='block'; document.getElementById('qr-input').value=''; document.getElementById('qr-upload-file').value=''; const populate = (containerId, items, values) => { const container = document.getElementById(containerId); container.innerHTML = ""; items.forEach((item, i) => { const val = values ? values[i] : item; const isChecked = (val === this.week || val === this.course); container.innerHTML += `<label style="display:flex; align-items:center; padding:2px 0;"><input type="checkbox" class="${containerId === 'qr-course-checkboxes' ? 'qr-course-cb' : 'qr-week-cb'}" value="${val.toString().replace(/\s/g,'')}" ${isChecked?'checked':''}> <span style="margin-left:5px">${item}</span></label>`; }); }; populate('qr-course-checkboxes', sysConfig.attCourses, sysConfig.attCourses); const weekLabels = []; const weekValues = []; const fullCourseName = sysConfig.attCourses.find(c => c.replace(/\s/g, '') === this.course); for(let i=1; i<=sysConfig.totalWeeks; i++) { weekLabels.push(getWeekLabel(i, fullCourseName)); weekValues.push(i); } populate('qr-week-checkboxes', weekLabels, weekValues); }, processQRData: async function() { const fileInput = document.getElementById('qr-upload-file'); const textArea = document.getElementById('qr-input').value; const selectedCourses = Array.from(document.querySelectorAll('.qr-course-cb:checked')).map(cb => cb.value); const selectedWeeks = Array.from(document.querySelectorAll('.qr-week-cb:checked')).map(cb => parseInt(cb.value)); if (selectedCourses.length === 0) return alert("Please select at least one course."); if (selectedWeeks.length === 0) return alert("Please select at least one week."); if (fileInput.files.length > 0) { const r = new FileReader(); r.onload = e => { const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'}); this.processBulkAttendance(wb, selectedWeeks, selectedCourses); }; r.readAsArrayBuffer(fileInput.files[0]); } else if (textArea.trim()) { this.executeScan(textArea, selectedWeeks, selectedCourses); } else { alert("Please paste a list or upload a file."); } }, processBulkAttendance: async function(wb, allowedWeeks, allowedCourses) { let batchAtt = []; let batchStudents = []; let count = 0; for (let i = 0; i < wb.SheetNames.length; i++) { const sheetName = wb.SheetNames[i]; const ws = wb.Sheets[sheetName]; const data = XLSX.utils.sheet_to_json(ws); let targetClean = allowedCourses.find(c => c.toLowerCase() === sheetName.toLowerCase().replace(/\s/g,'')); if (!targetClean && wb.SheetNames.length === 1 && allowedCourses.length === 1) targetClean = allowedCourses[0]; if (!targetClean) continue; const targetFull = sysConfig.attCourses.find(c => c.replace(/\s/g,'') === targetClean); let lvl = 0; const match = targetFull.match(/\d+/); if(match) lvl = Math.floor(parseInt(match[0])/100) * 100; data.forEach(row => { const id = String(row['ID'] || row['Index ID'] || row['Student ID'] || row['__EMPTY'] || '').trim(); let name = "Unknown"; for (const k in row) { if (k.toLowerCase().includes('name')) name = row[k]; } if (!id || id.length < 5) return; let s = this.cache.find(x => x.id === id); if (!s) { s = {id: id, name: formatName(name), level: lvl, courses: [targetFull]}; batchStudents.push(s); this.cache.push(s); } else if (!s.courses.includes(targetFull)) { if (!batchStudents.find(bs => bs.id === id)) { s.courses.push(targetFull); batchStudents.push(s); } } Object.keys(row).forEach(key => { const weekMatch = key.match(/^(?:Week|Wk|W)\s*(\d+)$/i) || (key.match(/^\d+$/) ? [key, key] : null); if (weekMatch) { const weekNum = parseInt(weekMatch[1]); if (allowedWeeks.includes(weekNum) && weekNum <= sysConfig.totalWeeks) { const val = row[key]; let status = "Absent"; if (val == 1 || String(val).toLowerCase().startsWith('p') || String(val).toLowerCase() === 'yes') { status = "Present"; } const dbKey = `${targetClean}_W${weekNum}_${id}`; batchAtt.push({key: dbKey, status, course: targetClean, week: weekNum, id}); this.attMap.set(dbKey, status); count++; } } }); }); } if(batchStudents.length > 0) await db.batchPut('students', batchStudents); if(batchAtt.length > 0) await db.batchPut('attendance', batchAtt); document.getElementById('qr-modal').style.display='none'; this.updateContext(); alert(`Excel Upload Complete.\nProcessed ${count} entries.`); }, executeScan: async function(raw, targetWeeks, targetCourses) { if(!raw.trim()) return; let pairs = []; (raw.match(/\{.*?\}/g)||[]).forEach(j => { try{ let o=JSON.parse(j); let i=o.student_id||o["ID NUMBER"]; if(i) pairs.push({id:String(i).trim(), name:"Unknown"}); }catch(e){} }); const lines = raw.split(/[\r\n]+/); lines.forEach(l => { let m = l.match(/\b\d{8,}\b/); if(m) { let id = m[0]; let rawName = l.replace(id, "").trim(); let name = rawName ? formatName(rawName) : "Unknown"; pairs.push({id, name}); } }); let displayList = []; let uniqueSet = new Set(); for(let p of pairs) { if(uniqueSet.has(p.id)) continue; uniqueSet.add(p.id); let s = this.cache.find(x => x.id === p.id); let status = "New Student"; if(s) { if(s.name !== "UNKNOWN") p.name = s.name; status = "Found in DB"; } displayList.push({...p, status}); } this.pendingBatch = displayList; this.scanTargetWeeks = targetWeeks; this.scanTargetCourses = targetCourses; document.getElementById('scan-week-display').innerText = `${targetWeeks.length} Wks / ${targetCourses.length} Courses`; const tbody = document.getElementById('scan-list-body'); tbody.innerHTML = ""; displayList.forEach(item => { let badgeClass = item.status === "Found in DB" ? "st-present" : "st-new"; tbody.innerHTML += `<tr class="confirm-row"><td><input type="checkbox" class="scan-check" value="${item.id}" checked></td><td style="font-family:monospace; color:var(--ug-blue); font-weight:bold;">${item.id}</td><td>${item.name}</td><td style="text-align:center;"><span class="scan-status-badge ${badgeClass}">${item.status}</span></td></tr>`; }); document.getElementById('qr-modal').style.display='none'; document.getElementById('scan-override-modal').style.display='block'; }, toggleScanChecks: function(state) { document.querySelectorAll('.scan-check').forEach(cb => cb.checked = state); }, saveScanOverrides: async function() { const checkedIDs = Array.from(document.querySelectorAll('.scan-check:checked')).map(cb => cb.value); const toSave = this.pendingBatch.filter(item => checkedIDs.includes(item.id)); let batchAtt = []; let batchStudents = []; for(let cleanC of this.scanTargetCourses) { const fullC = sysConfig.attCourses.find(c => c.replace(/\s/g, '') === cleanC); let lvl = 0; const match = fullC.match(/\d+/); if(match) lvl = Math.floor(parseInt(match[0])/100) * 100; for(let item of toSave) { let s = this.cache.find(x => x.id === item.id); if(!s) { s = {id: item.id, name: item.name, level: lvl, courses: [fullC]}; batchStudents.push(s); this.cache.push(s); } else if (!s.courses.includes(fullC)) { if(!batchStudents.find(b=>b.id===s.id)) { s.courses.push(fullC); batchStudents.push(s); } } for(let w of this.scanTargetWeeks) { const key = `${cleanC}_W${w}_${item.id}`; batchAtt.push({key, status:'Present', course:cleanC, week:w, id:item.id}); this.attMap.set(key, 'Present'); } } } if(batchStudents.length > 0) await db.batchPut('students', batchStudents); if(batchAtt.length > 0) await db.batchPut('attendance', batchAtt); document.getElementById('scan-override-modal').style.display='none'; this.updateContext(); alert(`Success! Marked ${toSave.length} students Present across ${this.scanTargetCourses.length} courses and ${this.scanTargetWeeks.length} weeks.`); }, closeModal: function() { document.getElementById('new-student-modal').style.display='none'; this.pending=[]; }, confirmAddStudents: async function() { let batch = []; let lvl=0; const match = this.course.match(/\d+/); if(match) lvl = Math.floor(parseInt(match[0])/100) * 100; const cleanC = this.course.replace(/\s/g, ''); const targetW = this.week; for(let p of this.pending) { const finalName = formatName(p.name); const fullC = sysConfig.attCourses.find(c => c.replace(/\s/g, '') === cleanC); const s = {id:p.id, name: finalName, level:lvl, courses:[fullC]}; await db.put('students', s); this.cache.push(s); const key = `${cleanC}_W${targetW}_${p.id}`; this.attMap.set(key, 'Present'); batch.push({key, status:'Present', course:cleanC, week:targetW, id:p.id}); } if(batch.length) await db.batchPut('attendance', batch); this.closeModal(); this.updateContext(); alert(`${this.pending.length} New students added and marked Present.`); }, downloadReport: function() { const wb = XLSX.utils.book_new(); const curW = dashApp.currentWeek; sysConfig.attCourses.forEach(c => { const cleanC = c.replace(/\s/g,''); const list = this.cache.filter(s => s.courses && s.courses.includes(c)); list.sort((a,b)=>a.id.localeCompare(b.id)); const data = list.map(s => { let r = {"Index ID": s.id, "Name": s.name}; let t = 0; for(let w=1; w<=sysConfig.totalWeeks; w++) { if(w > curW) { r[`Week ${w}`] = ""; } else { const st = this.getAtt(s.id,w,cleanC); r[`Week ${w}`] = (st === 'Present' ? "1" : "0"); if(st==='Present') t++; } } r["Total"] = t + "/" + sysConfig.totalWeeks; return r; }); const ws = XLSX.utils.json_to_sheet(data); ws['!cols'] = [{wch:15}, {wch:30}, ...Array(sysConfig.totalWeeks).fill({wch:5}), {wch:10}]; XLSX.utils.book_append_sheet(wb, ws, c); }); const fn = getDownloadFileName('AttendanceReport'); XLSX.writeFile(wb, fn); }, finalizeRestore: async function() { const checkedCourses = Array.from(document.querySelectorAll('.att-sel-check:checked')).map(c => c.value); const finalBatch = this.pendingBatch.filter(b => checkedCourses.includes(b.course)); if(finalBatch.length > 0) { await db.batchPut('attendance', finalBatch); await this.sync(); this.updateContext(); alert(`Restoration Complete.\n${finalBatch.length} records saved.`); } document.getElementById('att-confirm-modal').style.display='none'; } };
    
    // --- TA PORTAL ---
    taApp = {
        data: [], current: null, attSort: {col:'id', asc:true}, gradeSort: {col:'id', asc:true}, attSearch: '', gradeSearch: '',
        init: async function() { this.data = await db.getAll('ta_store'); this.renderList(); },
        import: function() { document.getElementById('ta-file-input').click(); },
        handleFile: function(input) {
            const file = input.files[0]; if(!file) return; const r = new FileReader();
            r.onload = async (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    let toSave = [];
                    if (json.config && json.students) toSave.push({ id: json.config.taName || ("TA_"+Date.now()), data: json });
                    else for (let key in json) if (json[key].config) toSave.push({ id: key, data: json[key] });
                    if (toSave.length === 0) return alert("Invalid File.");
                    await db.batchPut('ta_store', toSave); alert(`Imported ${toSave.length} TAs.`); this.init();
                } catch(err) { alert("Error: "+err.message); }
            }; r.readAsText(file); input.value = '';
        },
        renderList: function() {
            const con = document.getElementById('ta-list-container'); con.innerHTML = '';
            if (this.data.length === 0) { con.innerHTML = '<div class="empty-state">No TA Data. Click Import.</div>'; return; }
            this.data.forEach(item => {
                const ta = item.data; const name = ta.config ? ta.config.taName : item.id; const courses = ta.config ? ta.config.courses.map(c => c.code + " G" + c.grp).join(", ") : "N/A";
                con.innerHTML += `<div class="ta-card"><div class="ta-info" onclick="taApp.view('${item.id}')" style="flex-grow:1;"><h3>${name}</h3><p><strong>Courses:</strong> ${courses}</p><p><strong>Students:</strong> ${ta.students ? ta.students.length : 0}</p></div><button class="btn btn-danger" onclick="taApp.delete('${item.id}')">Delete</button></div>`;
            });
        },
        delete: async function(id) { if(confirm("Delete this TA?")) { await db.delete('ta_store', id); this.init(); } },
        view: function(id) {
            const item = this.data.find(x => x.id === id); if(!item) return;
            this.current = item.data;
            document.getElementById('ta-list-view').style.display = 'none'; document.getElementById('ta-details-view').style.display = 'block';
            document.getElementById('ta-det-name').innerText = (this.current.config ? this.current.config.taName : id);
            document.getElementById('ta-det-id').innerText = id;
            this.switchTab('overview');
        },
        closeDetails: function() { document.getElementById('ta-details-view').style.display = 'none'; document.getElementById('ta-list-view').style.display = 'block'; this.current = null; },
        switchTab: function(tab) {
            document.querySelectorAll('.ta-sub-tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.ta-pane').forEach(p => p.classList.remove('active'));
            if(tab === 'overview') document.querySelector('.ta-sub-tab:nth-child(1)').classList.add('active');
            if(tab === 'attendance') document.querySelector('.ta-sub-tab:nth-child(2)').classList.add('active');
            if(tab === 'grades') document.querySelector('.ta-sub-tab:nth-child(3)').classList.add('active');
            document.getElementById(`ta-tab-${tab}`).classList.add('active');
            if(tab === 'overview') this.renderOverview(); if(tab === 'attendance') this.setupAtt(); if(tab === 'grades') this.setupGrades();
        },
        renderOverview: function() {
            const ta = this.current;
            let totalTasks = 0, completedTasks = 0;
            const totalWeeks = ta.config.weeks || 13;
            const currentSysWeek = dashApp.currentWeek || 1;

            for(let w=1; w<=totalWeeks; w++) { ta.config.courses.forEach(c => { totalTasks++; if(ta.tasks.includes(`${c.id}_W${w}`)) completedTasks++; }); }
            document.getElementById('ta-stats').innerHTML = `<div class="ta-stat"><div>Students</div><div>${ta.students.length}</div></div><div class="ta-stat"><div>Classes</div><div>${ta.config.courses.length}</div></div><div class="ta-stat"><div>Tasks Done</div><div>${completedTasks} / ${totalTasks}</div></div>`;
            const accContainer = document.getElementById('ta-tasks-accordion');
            accContainer.innerHTML = "";
            for(let w=1; w<=totalWeeks; w++) {
                let content = "";
                ta.config.courses.forEach(c => {
                    const tid = `${c.id}_W${w}`; const done = ta.tasks.includes(tid);
                    content += `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #f1f1f1;"><span>${c.code} G${c.grp}</span><span class="badge ${done?'bg-green':'bg-red'}">${done?'Done':'Pending'}</span></div>`;
                });
                const isOpen = (w === currentSysWeek) ? 'open' : '';
                accContainer.innerHTML += `<details class="week-acc" ${isOpen}><summary>Week ${w}</summary><div class="ta-acc-content">${content}</div></details>`;
            }
        },
        setupAtt: function() {
            const sc = document.getElementById('ta-att-course'); const sw = document.getElementById('ta-att-week');
            sc.innerHTML = ''; sw.innerHTML = '';
            this.current.config.courses.forEach(c => { sc.innerHTML += `<option value="${c.id}">${c.code} G${c.grp}</option>`; });
            for(let i=1; i<=this.current.config.weeks; i++) sw.innerHTML += `<option value="${i}">Week ${i}</option>`;
            this.renderAtt();
        },
        renderAtt: function() {
            const cid = document.getElementById('ta-att-course').value;
            const w = document.getElementById('ta-att-week').value;
            const search = document.getElementById('ta-att-search').value.toLowerCase();
            const body = document.getElementById('ta-att-body'); body.innerHTML = '';
            let students = this.current.students.filter(s => s.grp === cid && (s.name.toLowerCase().includes(search) || s.id.includes(search)));
            const col = this.attSort.col; const asc = this.attSort.asc;
            students.sort((a,b) => { let valA, valB; if(col === 'status') { valA = this.current.attendance.includes(`${cid}_W${w}_${a.id}`) ? 'Present' : 'Absent'; valB = this.current.attendance.includes(`${cid}_W${w}_${b.id}`) ? 'Present' : 'Absent'; } else { valA = a[col]; valB = b[col]; } if(valA < valB) return asc ? -1 : 1; if(valA > valB) return asc ? 1 : -1; return 0; });
            ['id','name','status'].forEach(c => { document.getElementById(`ta-sort-att-${c}`).className = 'sort-arrow ' + (col===c ? (asc ? 'sort-asc' : 'sort-desc') : 'sort-none'); });
            let presents = 0; let absents = 0;
            students.forEach(s => {
                const aid = `${cid}_W${w}_${s.id}`; const isP = this.current.attendance.includes(aid); if(isP) presents++; else absents++;
                let totalP = 0; for(let i=1; i<=this.current.config.weeks; i++) { if(this.current.attendance.includes(`${cid}_W${i}_${s.id}`)) totalP++; }
                body.innerHTML += `<tr><td>${s.id}</td><td>${s.name}</td><td>${totalP} / ${this.current.config.weeks}</td><td><span class="badge ${isP?'bg-green':'bg-red'}">${isP?'Present':'Absent'}</span></td></tr>`;
            });
            document.getElementById('ta-att-headcount').innerHTML = `<div class="ta-hc-item"><span class="badge bg-green">P</span> Present: ${presents}</div><div class="ta-hc-item"><span class="badge bg-red">A</span> Absent: ${absents}</div><div class="ta-hc-item">Total: ${students.length}</div>`;
        },
        sortAtt: function(col) { if(this.attSort.col===col) this.attSort.asc=!this.attSort.asc; else {this.attSort.col=col; this.attSort.asc=true;} this.renderAtt(); },
        setupGrades: function() {
            const sc = document.getElementById('ta-grade-course'); sc.innerHTML = '';
            this.current.config.courses.forEach(c => { sc.innerHTML += `<option value="${c.id}">${c.code} G${c.grp}</option>`; });
            this.renderGrades();
        },
        renderGrades: function() {
            const cid = document.getElementById('ta-grade-course').value;
            const search = document.getElementById('ta-grade-search').value.toLowerCase();
            const head = document.getElementById('ta-grade-head'); const body = document.getElementById('ta-grade-body');
            const asses = this.current.assessments.filter(a => a.grp === cid);
            let students = this.current.students.filter(s => s.grp === cid && (s.name.toLowerCase().includes(search) || s.id.includes(search)));
            const col = this.gradeSort.col; const asc = this.gradeSort.asc;
            students.sort((a,b) => { let vA=a[col], vB=b[col]; if(vA<vB) return asc?-1:1; if(vA>vB) return asc?1:-1; return 0; });
            let h = `<tr><th onclick="taApp.sortGrade('id')">ID ${col=='id'?(asc?'‚ñ≤':'‚ñº'):''}</th><th onclick="taApp.sortGrade('name')">Name ${col=='name'?(asc?'‚ñ≤':'‚ñº'):''}</th>`;
            asses.forEach(a => h += `<th>${a.name}</th>`); head.innerHTML = h + '</tr>';
            let b = '';
            students.forEach(s => {
                b += `<tr><td>${s.id}</td><td>${s.name}</td>`;
                asses.forEach(a => { const gid = `${s.id}_${a.id}`; const g = this.current.grades.find(x => x.id === gid); b += `<td>${g ? g.val : '-'}</td>`; });
                b += '</tr>';
            });
            body.innerHTML = b;
        },
        sortGrade: function(col) { if(this.gradeSort.col===col) this.gradeSort.asc=!this.gradeSort.asc; else {this.gradeSort.col=col; this.gradeSort.asc=true;} this.renderGrades(); },
        openExport: function() {
            const coursesDiv = document.getElementById('ta-exp-courses');
            const weeksDiv = document.getElementById('ta-exp-weeks');
            coursesDiv.innerHTML = ''; weeksDiv.innerHTML = '';
            this.current.config.courses.forEach(c => {
                coursesDiv.innerHTML += `<label style="display:block; padding:5px;"><input type="checkbox" class="ta-exp-c" value="${c.id}" checked> ${c.code} G${c.grp}</label>`;
            });
            for(let i=1; i<=this.current.config.weeks; i++) {
                weeksDiv.innerHTML += `<label style="display:block; padding:5px;"><input type="checkbox" class="ta-exp-w" value="${i}" checked> Week ${i}</label>`;
            }
            document.getElementById('ta-export-modal').style.display = 'block';
        },
        runExport: function(type) {
            const selectedC = Array.from(document.querySelectorAll('.ta-exp-c:checked')).map(c=>c.value);
            const selectedW = Array.from(document.querySelectorAll('.ta-exp-w:checked')).map(c=>parseInt(c.value));
            if(selectedC.length===0 || selectedW.length===0) return alert("Select at least one Course and Week.");
            
            const exportData = {};
            selectedC.forEach(cid => {
                const courseName = this.current.config.courses.find(x=>x.id===cid).code + "_G" + this.current.config.courses.find(x=>x.id===cid).grp;
                const students = this.current.students.filter(s => s.grp === cid);
                
                const sheetData = students.map(s => {
                    let row = { ID: s.id, Name: s.name };
                    selectedW.forEach(w => {
                        const isP = this.current.attendance.includes(`${cid}_W${w}_${s.id}`);
                        row[`Week ${w}`] = isP ? "Present" : "Absent";
                    });
                    const asses = this.current.assessments.filter(a => a.grp === cid);
                    asses.forEach(a => {
                        const g = this.current.grades.find(x => x.id === `${s.id}_${a.id}`);
                        row[`Grade: ${a.name}`] = g ? g.val : "";
                    });
                    return row;
                });
                exportData[courseName] = sheetData;
            });

            if (type === 'json') {
                const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: "application/json"});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${this.current.config.taName}_Export.json`;
                a.click();
            } else {
                const wb = XLSX.utils.book_new();
                for (let sheet in exportData) {
                    const ws = XLSX.utils.json_to_sheet(exportData[sheet]);
                    XLSX.utils.book_append_sheet(wb, ws, sheet.substring(0,30));
                }
                XLSX.writeFile(wb, `${this.current.config.taName}_Export.xlsx`);
            }
            document.getElementById('ta-export-modal').style.display='none';
        }
    };

    // --- CHISAG APP (UPDATED: PERFORMANCE + SPACING) ---
    chisagApp = {
        members: [], currentImg: '', isManageMode: false, selected: new Set(), sortCol: 'id', sortAsc: true, filterLvl: 0,
        init: async function() {
            const dSel = document.getElementById('c-mod-dob-day');
            if(dSel.options.length === 1) {
                for(let i=1; i<=31; i++) {
                    const opt = document.createElement('option');
                    opt.value = i < 10 ? '0'+i : i; opt.text = i;
                    dSel.appendChild(opt);
                }
            }
            this.members = await db.getAll('chisag_members');
            this.render();
        },
        toggleManageMode: function() {
            this.isManageMode = !this.isManageMode;
            this.selected.clear();
            document.getElementById('chisag-delete-controls').style.display = this.isManageMode ? 'block' : 'none';
            document.getElementById('chisag-th-check').style.display = this.isManageMode ? 'table-cell' : 'none';
            this.render();
        },
        toggleSelect: function(id) {
            if(this.selected.has(id)) this.selected.delete(id); else this.selected.add(id);
        },
        toggleSelectAll: function(cb) {
            if(cb.checked) this.members.forEach(m => this.selected.add(m.id));
            else this.selected.clear();
            this.render();
        },
        deleteSelected: async function() {
            if(this.selected.size === 0) return alert("No members selected.");
            if(confirm(`Delete ${this.selected.size} selected members?`)) {
                await db.batchDel('chisag_members', Array.from(this.selected));
                this.members = await db.getAll('chisag_members');
                this.toggleManageMode();
                this.render();
                alert("Members Deleted.");
            }
        },
        filterByLevel: function(lvl) {
            this.filterLvl = lvl;
            this.render();
        },
        sort: function(col) {
            if(this.sortCol===col) this.sortAsc = !this.sortAsc;
            else { this.sortCol = col; this.sortAsc = true; }
            this.render();
        },
        lookup: async function() {
            const id = document.getElementById('chisag-input-id').value.trim();
            if(!id) return alert("Please enter an ID.");
            
            this.currentImg = ''; 
            let member = this.members.find(m => m.id === id);
            
            if (!member) {
                const student = await db.get('students', id);
                if (student) {
                    const names = student.name.split(' ');
                    const surname = names[0];
                    const other = names.slice(1).join(' ');
                    member = { id: student.id, surname: surname, otherNames: other, level: student.level, dob: '', email: '', dues: false, souvPaid: false, souvTaken: false, pic: '' };
                } else {
                    member = { id: id, surname: '', otherNames: '', level: 100, dob: '', email: '', dues: false, souvPaid: false, souvTaken: false, pic: '' };
                }
            }
            
            document.getElementById('c-mod-id').value = member.id;
            document.getElementById('c-mod-surname').value = member.surname;
            document.getElementById('c-mod-othernames').value = member.otherNames;
            document.getElementById('c-mod-level').value = member.level || 100;
            const dobParts = (member.dob || "").split('-');
            if(dobParts.length === 2) {
                document.getElementById('c-mod-dob-day').value = dobParts[0];
                document.getElementById('c-mod-dob-month').value = dobParts[1];
            } else {
                document.getElementById('c-mod-dob-day').value = "";
                document.getElementById('c-mod-dob-month').value = "";
            }
            document.getElementById('c-mod-email').value = member.email || '';
            document.getElementById('c-mod-dues').checked = member.dues;
            document.getElementById('c-mod-souv-paid').checked = member.souvPaid;
            document.getElementById('c-mod-souv-taken').checked = member.souvTaken;
            this.currentImg = member.pic || '';
            this.updateImagePreview();
            document.getElementById('chisag-member-modal').style.display = 'block';
        },
        handleImageUpload: function(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                this.currentImg = e.target.result;
                this.updateImagePreview();
            };
            reader.readAsDataURL(file);
        },
        updateImagePreview: function() {
            const div = document.getElementById('c-img-preview');
            if(this.currentImg) div.innerHTML = `<img src="${this.currentImg}" style="width:100%; height:100%; object-fit:cover;">`;
            else div.innerHTML = `<span style="color:#999; font-size:3rem;">üì∑</span>`;
        },
        saveMember: async function() {
            const id = document.getElementById('c-mod-id').value;
            const surname = document.getElementById('c-mod-surname').value;
            const other = document.getElementById('c-mod-othernames').value;
            const d = document.getElementById('c-mod-dob-day').value;
            const m = document.getElementById('c-mod-dob-month').value;
            const dobStr = (d && m) ? `${d}-${m}` : "";

            if(!surname) return alert("Surname is required");
            const member = {
                id: id, surname: surname, otherNames: other,
                name: surname + " " + other, 
                level: parseInt(document.getElementById('c-mod-level').value),
                dob: dobStr,
                email: document.getElementById('c-mod-email').value,
                dues: document.getElementById('c-mod-dues').checked,
                souvPaid: document.getElementById('c-mod-souv-paid').checked,
                souvTaken: document.getElementById('c-mod-souv-taken').checked,
                pic: this.currentImg
            };
            await db.put('chisag_members', member);
            this.members = await db.getAll('chisag_members');
            document.getElementById('chisag-member-modal').style.display = 'none';
            document.getElementById('chisag-input-id').value = '';
            this.render();
            alert("Member Saved.");
        },
        deleteMember: async function() {
            const id = document.getElementById('c-mod-id').value;
            if(confirm("Delete this member from CHISAG system?")) {
                await db.delete('chisag_members', id);
                this.members = await db.getAll('chisag_members');
                document.getElementById('chisag-member-modal').style.display = 'none';
                this.render();
            }
        },
        showPictureModal: function(imgSrc) {
            const modal = document.getElementById('picture-modal');
            const img = document.getElementById('picture-modal-img');
            img.src = imgSrc;
            modal.style.display = 'block';
        },
        showQR: function(id, name, level, pic) {
            document.getElementById('chisag-qr-modal').style.display = 'block';
            document.getElementById('qr-name-display').innerText = name;
            document.getElementById('qr-id-display').innerText = id;
            document.getElementById('qr-level-display').innerText = "LEVEL " + level;
            
            const photoBox = document.getElementById('qr-card-photo');
            if(pic) photoBox.innerHTML = `<img src="${pic}" class="id-card-photo">`;
            else photoBox.innerHTML = `<span style="color:#ccc; font-size:3rem;">üë§</span>`;

            document.getElementById('qr-display-area').innerHTML = "";
            new QRCode(document.getElementById("qr-display-area"), { text: id, width: 100, height: 100 });
        },
        downloadPDF: async function() {
            const element = document.getElementById('printable-id-card');
            
            // Fix for QR code canvas
            const qrBox = document.getElementById('qr-display-area');
            const canvas = qrBox.querySelector('canvas');
            if(canvas) {
                const img = new Image();
                img.src = canvas.toDataURL("image/png");
                img.style.width = "100%";
                img.style.height = "auto";
                qrBox.innerHTML = "";
                qrBox.appendChild(img);
            }

            await new Promise(resolve => setTimeout(resolve, 500)); 

            html2canvas(element, { scale: 3, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgProps = pdf.getImageProperties(imgData);
                const cardWidth = 85; 
                const cardHeight = (imgProps.height * cardWidth) / imgProps.width;
                
                const x = (210 - cardWidth) / 2; 
                const y = (297 - cardHeight) / 2 - 20; 
                
                pdf.addImage(imgData, 'JPEG', x, y, cardWidth, cardHeight);
                pdf.save(`ID_Card_${document.getElementById('qr-id-display').innerText}.pdf`);
            });
        },
        render: function() {
            document.getElementById('chisag-total-count').innerText = this.members.length;
            document.getElementById('chisag-paid-count').innerText = this.members.filter(m=>m.dues).length + " Paid";
            [100,200,300,400].forEach(l => { document.getElementById(`chisag-lvl-${l}`).innerText = this.members.filter(m => m.level === l).length; });

            const today = new Date();
            const currentMonth = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][today.getMonth()];
            const bdays = this.members.filter(m => m.dob && m.dob.includes(currentMonth));
            const bdayList = document.getElementById('chisag-bday-list');
            bdayList.innerHTML = "";
            bdays.sort((a,b) => parseInt(a.dob) - parseInt(b.dob));
            bdays.forEach(m => { bdayList.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee;"><strong>${m.dob}:</strong> ${m.surname} ${m.otherNames}</div>`; });
            if(bdays.length === 0) bdayList.innerHTML = "No birthdays this month.";

            let list = this.members;
            if(this.filterLvl > 0) list = list.filter(m => m.level === this.filterLvl);
            
            const col = this.sortCol; 
            const asc = this.sortAsc;
            list.sort((a,b) => { 
                let vA = a[col], vB = b[col];
                if(col === 'dues' || col === 'souvPaid' || col === 'souvTaken') { vA = vA.toString(); vB = vB.toString(); }
                if(vA < vB) return asc ? -1 : 1; 
                if(vA > vB) return asc ? 1 : -1; 
                return 0; 
            });

            // OPTIMIZED RENDER LOGIC (Performance fix)
            const tbody = document.getElementById('chisag-table-body');
            const rows = list.map((m, i) => {
                const fullName = m.surname + " " + m.otherNames;
                const picHtml = m.pic ? `<img src="${m.pic}" class="pic-thumbnail" onclick="chisagApp.showPictureModal('${m.pic}')">` : '<span style="font-size:1.5rem; color:#ccc;">üë§</span>';
                const checkHtml = this.isManageMode ? `<td><input type="checkbox" ${this.selected.has(m.id)?'checked':''} onchange="chisagApp.toggleSelect('${m.id}')"></td>` : '';
                
                return `<tr>
                    ${checkHtml}
                    <td>${i+1}</td>
                    <td style="text-align:center;">${picHtml}</td>
                    <td style="font-weight:bold; font-family:monospace; color:var(--ug-blue);">${m.id}</td>
                    <td>${m.surname}</td>
                    <td>${m.otherNames}</td>
                    <td>${m.level}</td>
                    <td><span class="badge ${m.dues?'bg-green':'bg-red'}">${m.dues?'PAID':'OWING'}</span></td>
                    <td><span class="badge ${m.souvPaid?'bg-green':'bg-yellow'}">${m.souvPaid?'YES':'NO'}</span></td>
                    <td><span class="badge ${m.souvTaken?'bg-green':'bg-yellow'}">${m.souvTaken?'YES':'NO'}</span></td>
                    <td>
                        <button class="btn btn-gold" style="padding:2px 8px; font-size:0.75rem;" onclick="chisagApp.showQR('${m.id}','${fullName}', ${m.level}, '${m.pic}')">QR ID</button>
                        <button class="btn btn-reset" style="padding:2px 8px; font-size:0.75rem;" onclick="document.getElementById('chisag-input-id').value='${m.id}'; chisagApp.lookup()">Edit</button>
                    </td>
                </tr>`;
            }).join('');
            
            tbody.innerHTML = rows;
        },
        importFile: function(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = async (e) => {
                const buffer = e.target.result;
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(buffer);
                const worksheet = workbook.getWorksheet(1);

                const bufToBase64 = (buf) => {
                    let binary = '';
                    const bytes = new Uint8Array(buf);
                    for (let i = 0; i < bytes.byteLength; i++) { binary += String.fromCharCode(bytes[i]); }
                    return window.btoa(binary);
                };

                const images = {};
                worksheet.getImages().forEach(image => {
                    const imgId = image.imageId;
                    const img = workbook.model.media.find(m => m.index === imgId);
                    const row = Math.floor(image.range.tl.nativeRow) + 1; 
                    if (img) {
                        images[row] = `data:${img.type};base64,${bufToBase64(img.buffer)}`;
                    }
                });

                let count = 0;
                worksheet.eachRow((row, rowNumber) => {
                    if (rowNumber === 1) return;
                    const idVal = row.getCell(3).value;
                    if (!idVal) return;

                    const member = {
                        id: String(idVal).trim(),
                        surname: String(row.getCell(4).value || '').toUpperCase(),
                        otherNames: String(row.getCell(5).value || '').toUpperCase(),
                        level: parseInt(row.getCell(6).value) || 100,
                        dob: String(row.getCell(7).value || ''),
                        dues: String(row.getCell(8).value || '').toLowerCase().includes('paid') || String(row.getCell(8).value || '').toLowerCase() === 'yes',
                        souvPaid: String(row.getCell(9).value || '').toLowerCase() === 'yes',
                        souvTaken: String(row.getCell(10).value || '').toLowerCase() === 'yes',
                        email: (row.getCell(11).value && row.getCell(11).value.text) ? row.getCell(11).value.text : String(row.getCell(11).value || ''),
                        pic: images[rowNumber] || '' 
                    };
                    this.members = this.members.filter(m => m.id !== member.id);
                    this.members.push(member);
                    count++;
                });

                await db.batchPut('chisag_members', this.members);
                this.render();
                alert(`Imported ${count} members with pictures.`);
                input.value = '';
            };
        },
        exportFile: async function() {
            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('CHISAG Members');
            ws.columns = [
                { header: 'No.', key: 'no', width: 5 },
                { header: 'Picture', key: 'pic', width: 15 }, 
                { header: 'Index ID', key: 'id', width: 15 },
                { header: 'Surname', key: 'surname', width: 20 },
                { header: 'Other Names', key: 'other', width: 25 },
                { header: 'Level', key: 'level', width: 10 },
                { header: 'DOB', key: 'dob', width: 15 },
                { header: 'Dues', key: 'dues', width: 10 },
                { header: 'Souv Paid', key: 'sp', width: 10 },
                { header: 'Souv Taken', key: 'st', width: 10 },
                { header: 'Email', key: 'email', width: 30 }
            ];

            this.members.forEach((m, i) => {
                const row = ws.addRow({
                    no: i+1,
                    pic: '',
                    id: m.id,
                    surname: m.surname,
                    other: m.otherNames,
                    level: m.level,
                    dob: m.dob,
                    dues: m.dues ? "Paid" : "Owing",
                    sp: m.souvPaid ? "Yes" : "No",
                    st: m.souvTaken ? "Yes" : "No",
                    email: m.email
                });
                row.height = 60; 

                if (m.pic) {
                    const imageId = wb.addImage({
                        base64: m.pic,
                        extension: 'png',
                    });
                    ws.addImage(imageId, {
                        tl: { col: 1, row: i + 1 }, 
                        br: { col: 2, row: i + 2 },
                        editAs: 'oneCell'
                    });
                }
            });

            const buf = await wb.xlsx.writeBuffer();
            saveAs(new Blob([buf]), 'CHISAG_Roster_Export.xlsx');
        }
    };

    window.onload = async function() { 
        await db.open(); 
        authApp.init(); 
    };
<script>
    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('App Registered', reg))
                .catch(err => console.log('App Error', err));
        });
    }
</script>
</body>
</html>